<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Entradas con Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 95%; margin-top: 2rem; }
        #reader, #sublocationReader { width: 100%; max-width: 450px; margin: 0 auto; border: 2px dashed #ccc; border-radius: 8px; }
        .qr-message, #scan-status, #sublocationScanStatus { text-align: center; }
        .message-success { color: #198754; font-weight: bold; }
        .message-error { color: #dc3545; font-weight: bold; }
        .message-warning { color: #ffc107; font-weight: bold; }
        .table-responsive { max-height: 60vh; }
        #msegTable td input[type="text"], #sublocationTable td, #ingresoItemsTable td input, #ingresoItemsTable td select { font-size: 0.85em; white-space: nowrap; }
        #msegTable .filename-display { background-color: #e9ecef !important; border-radius: 4px; padding: 2px 5px; }
        .checkbox-container { display: none; }
        .checkbox-container.visible { display: flex; align-items: end; }
        #sublocationTable thead th, #msegTable thead th {
            cursor: pointer;
            position: relative;
        }
        #sublocationTable thead th .sort-arrow, #msegTable thead th .sort-arrow {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
        }
        .reserva-col, .reserva-cell, .wbs-col, .so-col {
            display: none;
        }
        #spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1070;
            display: none;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>
<!-- SPINNER DE CARGA -->
<div id="spinner-overlay">
    <div class="spinner-border text-light" role="status">
        <span class="visually-hidden" data-translate="loading">Cargando...</span>
    </div>
</div>

<div class="container">
    <!-- SECCIÓN DE LOGIN -->
    <div id="loginSection">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body shadow-sm">
                        <h3 class="card-title text-center mb-4" data-translate="loginTitle">Login SAP</h3>
                        <div class="mb-3">
                            <label for="sapEnvSelect" class="form-label" data-translate="sapEnvironmentLabel">Entorno SAP</label>
                            <select class="form-select" id="sapEnvSelect">
                                <option value="PRD" data-host="172.16.16.32" data-sysnr="00" data-translate="prdEnvironment">Producción (PRD)</option>
                                <option value="QAS" data-host="172.16.16.10" data-sysnr="00" data-translate="qasEnvironment">Calidad (QAS)</option>
                                <option value="DEV" data-host="172.16.16.11" data-sysnr="00" data-translate="devEnvironment">Desarrollo (DEV)</option>
                            </select>
                        </div>
                        <div class="mb-3"><label for="sapClientInput" class="form-label" data-translate="clientLabel">Mandante</label><input type="text" class="form-control" id="sapClientInput"></div>
                        <div class="mb-3"><label for="sapUserInput" class="form-label" data-translate="userLabel">Usuario SAP</label><input type="text" class="form-control" id="sapUserInput"></div>
                        <div class="mb-3"><label for="sapPassInput" class="form-label" data-translate="passwordLabel">Contraseña</label><input type="password" class="form-control" id="sapPassInput"></div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="useSapRouter">
                            <label class="form-check-label" for="useSapRouter" data-translate="useSapRouterLabel">Usar SAP Router</label>
                        </div>
                        <div class="d-grid gap-2">
                            <button id="loginButton" class="btn btn-primary" data-translate="loginButton">Login</button>
                            <button id="guestLoginButton" class="btn btn-secondary" data-translate="guestLoginButton">Login de Invitado</button>
                        </div>
                        <p id="loginStatus" class="mt-3 text-center"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NUEVA SECCIÓN DE SELECCIÓN DE MODO -->
    <div id="modeSelectionSection" style="display: none;">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body shadow-sm">
                        <h3 class="card-title text-center mb-4" data-translate="selectModeTitle">Seleccione un Modo</h3>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="appMode" id="modeEtiqueta" value="etiqueta" checked>
                            <label class="form-check-label" for="modeEtiqueta" data-translate="labelReadingMode">Lectura de Etiqueta (QR)</label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="appMode" id="modeSublocation" value="sublocation">
                            <label class="form-check-label" for="modeSublocation" data-translate="sublocationQueryMode">Consulta por Sub-Ubicación</label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="appMode" id="modeIngreso" value="ingreso">
                            <label class="form-check-label" for="modeIngreso" data-translate="materialReceiptMode">Ingreso de Materiales por Pedido</label>
                        </div>
                        <div class="d-grid gap-2 mt-4">
                            <button id="continueButton" class="btn btn-primary" data-translate="continueButton">Continuar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTENIDO PRINCIPAL (Lectura de Etiqueta) -->
    <div id="mainContent" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="mb-0" data-translate="mainContentTitle">Captura de Movimientos (Lectura QR)</h2>
            <div>
                <button id="backButtonMain" class="btn btn-secondary me-2" data-translate="backButton">Volver</button>
                <span id="loggedInUserDisplay" class="badge bg-success me-3"></span>
                <button id="logoutButton" class="btn btn-danger" data-translate="logoutButton">Logout</button>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-7" id="headerDataSection"> 
                <div class="p-3 border rounded bg-light mb-4">
                    <h4 class="mb-3" data-translate="headerDataTitle">Datos de Cabecera</h4>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="clMovimiento" data-translate="moveTypeLabel">Cl.Movimiento:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="clMovimiento">
                                <button class="btn btn-outline-secondary" type="button" id="searchClMovimiento"><i class="bi bi-search"></i></button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="specialStockIndicator" data-translate="specialStockLabel">Stock Especial:</label>
                             <div class="input-group">
                                <input type="text" class="form-control" id="specialStockIndicator">
                                <button class="btn btn-outline-secondary" type="button" id="searchSpecialStock"><i class="bi bi-search"></i></button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="centro" data-translate="plantLabel">Centro:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="centro">
                                <button class="btn btn-outline-secondary" type="button" id="searchCentro"><i class="bi bi-search"></i></button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="almacen" data-translate="storageLocationLabel">Almacén:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="almacen">
                                <button class="btn btn-outline-secondary" type="button" id="searchAlmacen"><i class="bi bi-search"></i></button>
                            </div>
                        </div>
                        <div class="col-md-8"><label for="textoCabecera" data-translate="headerTextLabel">Texto Cabecera:</label><input type="text" class="form-control" id="textoCabecera"></div>
                        <div class="col-md-6"><label for="fechaContab" data-translate="postingDateLabel">Fecha Contab.:</label><input type="date" class="form-control" id="fechaContab"></div>
                        <div class="col-md-6 checkbox-container" id="reservaCheckboxContainer">
                            <div class="form-check pt-4"><input class="form-check-input" type="checkbox" id="reservaCheckbox"><label class="form-check-label" for="reservaCheckbox" data-translate="reservationLabel">Reserva</label></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-5">
                <label for="qr-content" data-translate="lastQrLabel">Último QR leído:</label>
                <p id="qr-content" class="form-control-plaintext border p-2 bg-light rounded mb-2"></p>
                <div id="reader" style="display: none;"><span class="qr-message p-3"></span></div>
                <button id="startScanButton" class="btn btn-primary mt-2" data-translate="activateCameraButton">Activar Cámara</button>
                <p id="scan-status" class="lead mt-2"></p>
            </div>
        </div>
        <div class="text-center my-3">
            <button id="reset-button" class="btn btn-warning me-2" style="display: none;" data-translate="clearButton">Limpiar</button>
            <button id="save-button" class="btn btn-success" style="display: none;" data-translate="saveButton">Guardar en SAP</button>
            <button id="layoutButtonMseg" class="btn btn-info" style="display: none;" data-bs-toggle="tooltip" title="Seleccionar Columnas"><i class="bi bi-layout-three-columns"></i></button>
        </div>
        <div class="table-responsive">
            <table id="msegTable" class="table table-bordered table-striped table-sm">
                <thead><tr>
                    <th data-column="docCol" data-translate="docCol">Documento</th>
                    <th data-column="yearCol" data-translate="yearCol">Año</th>
                    <th data-column="posCol" data-translate="posCol">Pos.</th>
                    <th data-column="materialCol" data-translate="materialCol">Material</th>
                    <th data-column="materialDescCol" data-translate="materialDescCol">Texto Material</th>
                    <th data-column="qtyCol" data-translate="qtyCol">Cantidad</th>
                    <th data-column="unitCol" data-translate="unitCol">Unidad</th>
                    <th data-column="batchCol" data-translate="batchCol">Lote</th>
                    <th data-column="certCol" style="min-width: 200px;" data-translate="certCol">Certificado</th>
                    <th data-column="docsCol" style="min-width: 200px;" data-translate="docsCol">Documentos</th>
                    <th data-column="inspCol" style="min-width: 200px;" data-translate="inspCol">Inspección</th>
                    <th data-column="itemTextCol" style="min-width: 150px;" data-translate="itemTextCol">Texto Pos.</th>
                    <th data-column="tagCol" data-translate="tagCol">TAG</th>
                    <th data-column="subLocCol" data-translate="subLocCol">Sub Ubicacion</th>
                    <th data-column="areaCol" style="min-width: 150px;" data-translate="areaCol">Área</th>
                    <th data-column="orderNoCol" data-translate="orderNoCol">Nro. Pedido</th>
                    <th data-column="wbsCol" data-translate="wbsCol">Elemento PEP</th>
                    <th data-column="reservationCol" class="reserva-col" data-translate="reservationCol">Reserva</th>
                    <th data-column="salesOrderCol" data-translate="salesOrderCol">Pedido Cliente</th>
                    <th data-column="salesOrderItemCol" data-translate="salesOrderItemCol">Pos. Pedido Cliente</th>
                </tr></thead>
                <tbody id="msegTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- NUEVO CONTENIDO PARA CONSULTA POR SUB-UBICACIÓN -->
    <div id="sublocationContent" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="mb-0" data-translate="sublocationQueryTitle">Consulta por Sub-Ubicación</h2>
            <div>
                <button id="backButtonSub" class="btn btn-secondary me-2" data-translate="backButton">Volver</button>
                <span id="loggedInUserDisplaySub" class="badge bg-success me-3"></span>
                <button id="logoutButtonSub" class="btn btn-danger" data-translate="logoutButton">Logout</button>
            </div>
        </div>
        <!-- Filtros y Cámara en la parte superior -->
        <div class="p-3 border rounded bg-light mb-4">
            <div class="row align-items-end">
                <div class="col-lg-8">
                    <h4 class="mb-3" data-translate="searchFiltersTitle">Filtros de Búsqueda</h4>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="sublocationCentro" data-translate="plantLabel">Centro:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="sublocationCentro">
                                <button class="btn btn-outline-secondary" type="button" id="searchSublocationCentro"><i class="bi bi-search"></i></button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="sublocationAlmacen" data-translate="storageLocationLabel">Almacén:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="sublocationAlmacen">
                                <button class="btn btn-outline-secondary" type="button" id="searchSublocationAlmacen"><i class="bi bi-search"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="row g-3 mt-2" id="sublocationAreaContainer" style="display: none;">
                        <div class="col-12">
                            <label class="form-label" data-translate="areaLabel">Área:</label>
                            <div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="sublocationArea" id="areaTodos" value="00" checked><label class="form-check-label" for="areaTodos" data-translate="allLabel">Todos</label></div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="sublocationArea" id="area01" value="01"><label class="form-check-label" for="area01">01</label></div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="sublocationArea" id="area02" value="02"><label class="form-check-label" for="area02">02</label></div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="sublocationArea" id="area03" value="03"><label class="form-check-label" for="area03">03</label></div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="sublocationArea" id="area04" value="04"><label class="form-check-label" for="area04">04</label></div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="sublocationArea" id="area05" value="05"><label class="form-check-label" for="area05">05</label></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <label for="sublocationQrContent" data-translate="lastQrLabel">Último QR leído:</label>
                    <p id="sublocationQrContent" class="form-control-plaintext border p-2 bg-light rounded mb-2"></p>
                    <div id="sublocationReader" style="display: none;"><span class="qr-message p-3"></span></div>
                    <button id="startSublocationScanButton" class="btn btn-primary mt-2" data-translate="activateCameraButton">Activar Cámara</button>
                    <p id="sublocationScanStatus" class="lead mt-2"></p>
                </div>
            </div>
        </div>
        <!-- Tabla de resultados abajo -->
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="mt-4" data-translate="searchResultsTitle">Resultados de la Búsqueda</h4>
            <div class="d-flex align-items-center">
                <input type="text" id="filterInput" class="form-control me-2" placeholder="Filtrar resultados..." data-translate="filterPlaceholder">
                <button id="exportToExcelButton" class="btn btn-success"><i class="bi bi-file-earmark-excel"></i></button>
                <button id="layoutButtonSub" class="btn btn-info ms-2" data-bs-toggle="tooltip" title="Seleccionar Columnas"><i class="bi bi-layout-three-columns"></i></button>
            </div>
        </div>
        <div class="table-responsive mt-2">
            <table id="sublocationTable" class="table table-bordered table-striped table-sm">
                <thead id="sublocationTableHead">
                    <tr>
                        <th data-column="MATNR">Material <span class="sort-arrow"></span></th>
                        <th data-column="MAKTX">Descripción <span class="sort-arrow"></span></th>
                        <th data-column="WERKS">Centro <span class="sort-arrow"></span></th>
                        <th data-column="LGORT">Almacén <span class="sort-arrow"></span></th>
                        <th data-column="CHARG">Lote <span class="sort-arrow"></span></th>
                        <th data-column="SOBKZ">Ind. Stock Esp. <span class="sort-arrow"></span></th>
                        <th data-column="KZBWS">Val. Stock Esp. <span class="sort-arrow"></span></th>
                        <th data-column="PS_PSP_PNR">Elemento PEP <span class="sort-arrow"></span></th>
                        <th data-column="ZZUBICACION">TAG <span class="sort-arrow"></span></th>
                        <th data-column="ZZSUB_UBICACION">Sub Ubicación <span class="sort-arrow"></span></th>
                        <th data-column="ZZ_PAIS">Pais <span class="sort-arrow"></span></th>
                        <th data-column="MEINS">Unidada de Medida <span class="sort-arrow"></span></th>
                        <th data-column="WAERS">Moneda <span class="sort-arrow"></span></th>
                        <th data-column="LABST">Stock Libre <span class="sort-arrow"></span></th>
                        <th data-column="WLABS">Valor Libre <span class="sort-arrow"></span></th>
                        <th data-column="UMLME">Stock Traslado <span class="sort-arrow"></span></th>
                        <th data-column="WUMLM">Valor Traslado <span class="sort-arrow"></span></th>
                        <th data-column="INSME">Stock Calidad <span class="sort-arrow"></span></th>
                        <th data-column="WINSM">Valor Calidad <span class="sort-arrow"></span></th>
                        <th data-column="EINME">Stock No Libre <span class="sort-arrow"></span></th>
                        <th data-column="WEINM">Valor No Libre <span class="sort-arrow"></span></th>
                        <th data-column="SPEME">Stock Bloqueado <span class="sort-arrow"></span></th>
                        <th data-column="WSPEM">Valor Bloqueado <span class="sort-arrow"></span></th>
                        <th data-column="RETME">Stock Devolución <span class="sort-arrow"></span></th>
                        <th data-column="WRETM">Valor Devolución <span class="sort-arrow"></span></th>
                    </tr>
                </thead>
                <tbody id="sublocationTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- NUEVO CONTENIDO PARA INGRESO DE MATERIALES -->
    <div id="ingresoContent" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="mb-0" data-translate="materialReceiptTitle">Ingreso de Materiales por Pedido</h2>
            <div>
                <button id="backButtonIngreso" class="btn btn-secondary me-2" data-translate="backButton">Volver</button>
                <span id="loggedInUserDisplayIngreso" class="badge bg-success me-3"></span>
                <button id="logoutButtonIngreso" class="btn btn-danger" data-translate="logoutButton">Logout</button>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <!-- CABECERA -->
                <h4 class="mb-3">Datos de Cabecera</h4>
                <div class="row g-3 p-3 border rounded bg-light mb-4">
                    <div class="col-md-3">
                        <label for="ingresoNroPedido" class="form-label">Nro de Pedido</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="ingresoNroPedido">
                            <button class="btn btn-primary" type="button" id="searchPoButton">Buscar Pedido</button>
                        </div>
                    </div>
                    <div class="col-md-2"><label for="ingresoTipoMovimiento" class="form-label">Tipo de Movimiento</label><input type="text" class="form-control" id="ingresoTipoMovimiento" value="101" readonly></div>
                    <div class="col-md-4">
                        <label class="form-label">Indicador de Stock Especial</label>
                        <div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="ingresoStockEspecial" id="stockSin" value="" checked><label class="form-check-label" for="stockSin">Sin Indicador</label></div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="ingresoStockEspecial" id="stockQ" value="Q"><label class="form-check-label" for="stockQ">Q</label></div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="ingresoStockEspecial" id="stockE" value="E"><label class="form-check-label" for="stockE">E</label></div>
                        </div>
                    </div>
                    <div class="col-md-3 d-flex align-items-end"><div class="form-check"><input class="form-check-input" type="checkbox" id="ingresoItemAdopted"><label class="form-check-label" for="ingresoItemAdopted">Item Adopted</label></div></div>
                    <div class="col-md-3"><label for="ingresoFechaDoc" class="form-label">Fecha de Documento</label><input type="date" class="form-control" id="ingresoFechaDoc"></div>
                    <div class="col-md-3"><label for="ingresoFechaCont" class="form-label">Fecha de Contabilización</label><input type="date" class="form-control" id="ingresoFechaCont"></div>
                    <div class="col-md-3"><label for="ingresoMaterialSlip" class="form-label">Material Slip (Nota de Entrega)</label><input type="text" class="form-control" id="ingresoMaterialSlip"></div>
                    <div class="col-md-3"><label for="ingresoTextoCabecera" class="form-label">Texto de Cabecera</label><input type="text" class="form-control" id="ingresoTextoCabecera"></div>
                </div>

                <!-- POSICIONES (ALV) -->
                <h4 class="mb-3 mt-4">Posiciones del Pedido</h4>
                <div class="table-responsive">
                    <table id="ingresoItemsTable" class="table table-bordered table-sm">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllIngresoItemsCheckbox"></th>
                                <th>Pos.</th>
                                <th>Material</th>
                                <th>Descripción</th>
                                <th class="wbs-col">Elemento PEP (WBS)</th>
                                <th class="so-col">Pedido Venta</th>
                                <th class="so-col">Pos. Ped. Venta</th>
                                <th>Planta</th>
                                <th>Almacén</th>
                                <th>Cantidad</th>
                                <th>UM</th>
                                <th>Lote</th>
                                <th>Sub-Ubicación</th>
                                <th>Certificado</th>
                                <th>Documentos</th>
                                <th>Inspección</th>
                            </tr>
                        </thead>
                        <tbody id="ingresoItemsTableBody">
                            <!-- Las filas se generarán dinámicamente -->
                        </tbody>
                    </table>
                </div>
                
                <hr>
                <div class="text-center">
                    <button id="ingresoClearButton" class="btn btn-warning me-2">Limpiar</button>
                    <button id="ingresoSaveButton" class="btn btn-success" disabled>Guardar en SAP</button>
                </div>
                 <p id="ingresoStatus" class="mt-3 text-center"></p>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE AYUDA DE BÚSQUEDA (MATCHCODE) -->
    <div class="modal fade" id="searchHelpModal" tabindex="-1" aria-labelledby="searchHelpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="searchHelpModalLabel" data-translate="searchHelpTitle">Ayuda para Búsqueda</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="searchHelpFilter" class="form-control mb-3" placeholder="Filtrar..." data-translate="filterPlaceholder">
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-hover table-sm">
                            <thead id="searchHelpTableHead"></thead>
                            <tbody id="searchHelpTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PARA FIRMAS Y ETIQUETA -->
    <div class="modal fade" id="signatureModal" tabindex="-1" aria-labelledby="signatureModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="signatureModalLabel" data-translate="additionalConfirmationTitle">Confirmación Adicional</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p data-translate="completeFollowingData">Por favor, complete los siguientes datos para finalizar el guardado.</p>
                    <div id="modal-error-message" class="alert alert-danger" style="display: none;"></div>
                    
                    <div class="mb-3">
                        <label for="receptorSelect" class="form-label" data-translate="receiverLabel">Receptor:</label>
                        <select id="receptorSelect" class="form-select" required>
                            <option value="" data-translate="loading">Cargando...</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="despachadorSelect" class="form-label" data-translate="dispatcherLabel">Despachador:</label>
                        <select id="despachadorSelect" class="form-select" required>
                            <option value="" data-translate="loading">Cargando...</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="labelSizeContainer">
                        <label for="labelSizeSelect" class="form-label" data-translate="labelSizeLabel">Tamaño de Etiqueta:</label>
                        <select id="labelSizeSelect" class="form-select" required>
                            <option value="" data-translate="selectSize">Seleccione un tamaño...</option>
                            <option value="S" data-translate="smallLabel">S - Pequeña</option>
                            <option value="M" data-translate="mediumLabel">M - Mediana</option>
                            <option value="L" data-translate="largeLabel">L - Grande</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Close" data-translate="cancelButton">Cancelar</button>
                    <button type="button" id="confirmSaveButton" class="btn btn-primary" data-translate="confirmAndSaveButton">Confirmar y Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PARA SELECCIÓN DE LAYOUT -->
    <div class="modal fade" id="layoutModal" tabindex="-1" aria-labelledby="layoutModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="layoutModalLabel" data-translate="layoutModalTitle">Seleccionar Columnas Visibles</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="layoutModalBody">
                    <!-- Content is now fully generated by JS -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="cancelButton">Cancelar</button>
                    <button type="button" id="applyLayoutButton" class="btn btn-primary" data-translate="applyButton">Aplicar</button>
                </div>
            </div>
        </div>
    </div>
</div>


<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // *** URL BASE PARA EL BACKEND EN PYTHON ***
    const API_BASE_URL = 'https://api.lndsap.com';

    // --- LÓGICA DE TRADUCCIÓN ---
    const translations = {
        en: {
            // General
            loading: "Loading...", user: "User", logoutButton: "Logout", continueButton: "Continue", cancelButton: "Cancel", clearButton: "Clear", saveButton: "Save to SAP", backButton: "Back", activateCameraButton: "Activate Camera", applyButton: "Apply", selectAll: "Select All", deselectAll: "Deselect All",
            // Login Screen
            loginTitle: "SAP Login", sapEnvironmentLabel: "SAP Environment", devEnvironment: "Development (DEV)", qasEnvironment: "Quality (QAS)", prdEnvironment: "Production (PRD)", clientLabel: "Client", userLabel: "SAP User", passwordLabel: "Password", useSapRouterLabel: "Use SAP Router", guestLoginButton: "Guest Login",
            // Mode Selection
            selectModeTitle: "Select a Mode", labelReadingMode: "Label Reading (QR)", sublocationQueryMode: "Query by Sublocation", materialReceiptMode: "Material Receipt by PO",
            // Label Reading Program
            mainContentTitle: "Movement Capture (QR Reading)", headerDataTitle: "Header Data", moveTypeLabel: "Move. Type:", specialStockLabel: "Special Stock:", plantLabel: "Plant:", storageLocationLabel: "Storage Loc.:", headerTextLabel: "Header Text:", postingDateLabel: "Posting Date:", reservationLabel: "Reservation", lastQrLabel: "Last QR Read:",
            // Sublocation Query Program
            sublocationQueryTitle: "Query by Sublocation", searchFiltersTitle: "Search Filters", areaLabel: "Area:", allLabel: "All", scanSublocationQr: "Scan the Sublocation's QR code", completeFiltersToScan: "Complete filters to scan.", searchResultsTitle: "Search Results", filterPlaceholder: "Filter results...", materialReceiptTitle: "Material Receipt by PO",
            // Modals
            searchHelpTitle: "Search Help", layoutModalTitle: "Select Visible Columns", additionalConfirmationTitle: "Additional Confirmation", completeFollowingData: "Please complete the following data to finalize saving.", receiverLabel: "Receiver:", dispatcherLabel: "Dispatcher:", labelSizeLabel: "Label Size:", selectSize: "Select a size...", smallLabel: "S - Small", mediumLabel: "M - Medium", largeLabel: "L - Large", confirmAndSaveButton: "Confirm and Save",
            // Table Headers
            docCol: "Document", yearCol: "Year", posCol: "Item", materialCol: "Material", materialDescCol: "Material Text", qtyCol: "Quantity", unitCol: "Unit", batchCol: "Batch", certCol: "Certificate", docsCol: "Documents", inspCol: "Inspection", itemTextCol: "Item Text", tagCol: "TAG", subLocCol: "Sublocation", areaCol: "Area", orderNoCol: "Order No.", wbsCol: "WBS Element", reservationCol: "Reservation", salesOrderCol: "Sales Order", salesOrderItemCol: "SO Item",
            // Sublocation Table Headers
            sublocationCol: "Sublocation", countryCol: "Country", uomCol: "Unit of Measure", currencyCol: "Currency", freeStockCol: "Free Stock", freeValueCol: "Free Value", transferStockCol: "Transfer Stock", transferValueCol: "Transfer Value", qualityStockCol: "Quality Stock", qualityValueCol: "Quality Value", nonFreeStockCol: "Non-Free Stock", nonFreeValueCol: "Non-Free Value", blockedStockCol: "Blocked Stock", blockedValueCol: "Blocked Value", returnsStockCol: "Returns Stock", returnsValueCol: "Returns Value",
            // Dynamic Messages
            validating: "Validating...", sessionClosed: "Session closed.", readyToScan: "Ready to scan", cameraError: "Error starting camera", scannerStopped: "Scanner stopped.", invalidQrFormat: "Unrecognized QR format.", codeAlreadyScanned: "Code already scanned.", processing: "Processing...", validationSuccess: "Validation successful.", networkError: "Network error", sessionError: "Session error.", loadingData: "Loading data...", confirmWindowError: "Could not open confirmation window", allFieldsRequired: "All visible fields are required.", preparingData: "Preparing data...", savingData: "Saving movement and uploading files...", processCompleted: "Process completed!", saveError: "Error while saving", noDataToExport: "No data to export.", noFilteredDataToExport: "The current filter returns no results to export.", processingSublocation: "Processing sublocation", recordsFound: "{count} records found.",
            // Search Help Translations
            searchHelpForPlant: "Search Help - Plant", searchHelpForStorage: "Search Help - Storage Location", searchHelpForMoveType: "Search Help - Movement Type", searchHelpForSpecialStock: "Search Help - Special Stock", plantCol: "Plant", plantNameCol: "Plant Name", storageCol: "Stor. Location", storageNameCol: "Location Name", moveTypeCol: "Move. Type", specialStockCol: "Special Stock",
            searchHelpForSublocation: "Search Help - Sublocation"
        },
        es: {
             // General
            loading: "Cargando...", user: "Usuario", logoutButton: "Logout", continueButton: "Continuar", cancelButton: "Cancelar", clearButton: "Limpiar", saveButton: "Guardar en SAP", backButton: "Volver", activateCameraButton: "Activar Cámara", applyButton: "Aplicar", selectAll: "Marcar todo", deselectAll: "Desmarcar todo",
            // Login Screen
            loginTitle: "Login SAP", sapEnvironmentLabel: "Entorno SAP", devEnvironment: "Desarrollo (DEV)", qasEnvironment: "Calidad (QAS)", prdEnvironment: "Producción (PRD)", clientLabel: "Mandante", userLabel: "Usuario SAP", passwordLabel: "Contraseña", useSapRouterLabel: "Usar SAP Router", guestLoginButton: "Login de Invitado",
            // Mode Selection
            selectModeTitle: "Seleccione un Modo", labelReadingMode: "Lectura de Etiqueta (QR)", sublocationQueryMode: "Consulta por Sub-Ubicación", materialReceiptMode: "Ingreso de Materiales por Pedido",
            // Label Reading Program
            mainContentTitle: "Captura de Movimientos (Lectura QR)", headerDataTitle: "Datos de Cabecera", moveTypeLabel: "Cl.Movimiento:", specialStockLabel: "Stock Especial:", plantLabel: "Centro:", storageLocationLabel: "Almacén:", headerTextLabel: "Texto Cabecera:", postingDateLabel: "Fecha Contab.:", reservationLabel: "Reserva", lastQrLabel: "Último QR leído:",
            // Sublocation Query Program
            sublocationQueryTitle: "Consulta por Sub-Ubicación", searchFiltersTitle: "Filtros de Búsqueda", areaLabel: "Área:", allLabel: "Todos", scanSublocationQr: "Escanee el código QR de la Sub-Ubicación", completeFiltersToScan: "Complete los filtros para escanear.", searchResultsTitle: "Resultados de la Búsqueda", filterPlaceholder: "Filtrar resultados...", materialReceiptTitle: "Ingreso de Materiales por Pedido",
            // Modals
            searchHelpTitle: "Ayuda para Búsqueda", layoutModalTitle: "Seleccionar Columnas Visibles", additionalConfirmationTitle: "Confirmación Adicional", completeFollowingData: "Por favor, complete los siguientes datos para finalizar el guardado.", receiverLabel: "Receptor:", dispatcherLabel: "Despachador:", labelSizeLabel: "Tamaño de Etiqueta:", selectSize: "Seleccione un tamaño...", smallLabel: "S - Pequeña", mediumLabel: "M - Mediana", largeLabel: "L - Grande", confirmAndSaveButton: "Confirmar y Guardar",
            // Table Headers
            docCol: "Documento", yearCol: "Año", posCol: "Pos.", materialCol: "Material", materialDescCol: "Texto Material", qtyCol: "Cantidad", unitCol: "Unidad", batchCol: "Lote", certCol: "Certificado", docsCol: "Documentos", inspCol: "Inspección", itemTextCol: "Texto Pos.", tagCol: "TAG", subLocCol: "Sub Ubicacion", areaCol: "Área", orderNoCol: "Nro. Pedido", wbsCol: "Elemento PEP", reservationCol: "Reserva", salesOrderCol: "Pedido Cliente", salesOrderItemCol: "Pos. Pedido Cliente",
            // Sublocation Table Headers
            sublocationCol: "Sub Ubicación", countryCol: "Pais", uomCol: "Unidada de Medida", currencyCol: "Moneda", freeStockCol: "Stock Libre Utilizacion", freeValueCol: "Valor Libre Utilizacion", transferStockCol: "Stock Traslado", transferValueCol: "Valor Traslado", qualityStockCol: "Stock Calidad", qualityValueCol: "Valor Calidad", nonFreeStockCol: "Stock No Libre", nonFreeValueCol: "Valor No Libre", blockedStockCol: "Stock Bloqueado", blockedValueCol: "Valor Bloqueado", returnsStockCol: "Stock Devolución", returnsValueCol: "Valor Devolución",
            // Dynamic Messages
            validating: "Validando...", sessionClosed: "Sesión cerrada.", readyToScan: "Listo para escanear", cameraError: "Error al iniciar cámara", scannerStopped: "Escáner detenido.", invalidQrFormat: "Formato de QR no reconocido.", codeAlreadyScanned: "Código ya escaneado.", processing: "Procesando...", validationSuccess: "Validación exitosa.", networkError: "Error de red", sessionError: "Error de sesión.", loadingData: "Cargando datos...", confirmWindowError: "No se pudo abrir la ventana de confirmación", allFieldsRequired: "Todos los campos visibles son obligatorios.", preparingData: "Preparando datos...", savingData: "Guardando movimiento y subiendo archivos...", processCompleted: "¡Proceso completado!", saveError: "Error al guardar", noDataToExport: "No hay datos para exportar.", noFilteredDataToExport: "El filtro actual no devuelve resultados para exportar.", processingSublocation: "Procesando sub-ubicación", recordsFound: "Se encontraron {count} registros.",
            // Search Help Translations
            searchHelpForPlant: "Ayuda para Búsqueda - Centro", searchHelpForStorage: "Ayuda para Búsqueda - Almacén", searchHelpForMoveType: "Ayuda para Búsqueda - Clase de Movimiento", searchHelpForSpecialStock: "Ayuda para Búsqueda - Stock Especial", plantCol: "Centro", plantNameCol: "Nombre Centro", storageCol: "Almacén", storageNameCol: "Nombre Almacén", moveTypeCol: "Clase Mov.", specialStockCol: "Stock Esp.",
            searchHelpForSublocation: "Ayuda para Búsqueda - Sub-Ubicación"
        }
    };

    let currentLang = 'es';

    function setLanguage(lang) {
        currentLang = lang;
        document.querySelectorAll('[data-translate]').forEach(el => {
            const key = el.getAttribute('data-translate');
            if (translations[lang] && translations[lang][key]) {
                if (el.placeholder) {
                    el.placeholder = translations[lang][key];
                } else {
                    el.textContent = translations[lang][key];
                }
            }
        });
        document.documentElement.lang = lang;
    }

    function getText(key, fallback = null) {
        return (translations[currentLang] && translations[currentLang][key]) || fallback || key;
    }

    const userLang = navigator.language.slice(0, 2).toLowerCase();
    setLanguage(userLang === 'es' ? 'es' : 'en');
    
    // --- VARIABLES GLOBALES ---
    let sapConnection = null;
    let html5QrCode = null;
    let html5QrCodeSublocation = null;
    let isScanning = false;
    let isSublocationScanning = false;
    let isGuestMode = false;
    const scannedCodes = new Map();
    const SAP_ROUTER_STRING = "/H/50.234.28.124/H/";
    let sublocationData = [];
    let sortState = { column: null, direction: 'asc' };
    let currentSearchHelpTarget = null;
    let msegColumnVisibility = {};
    let sublocationColumnVisibility = {};
    let currentLayoutConfig = {};
    let poItemsData = [];

    // --- Referencias al DOM ---
    const spinner = document.getElementById('spinner-overlay');
    const loginSection = document.getElementById('loginSection');
    const modeSelectionSection = document.getElementById('modeSelectionSection');
    const mainContent = document.getElementById('mainContent');
    const sublocationContent = document.getElementById('sublocationContent');
    const ingresoContent = document.getElementById('ingresoContent'); 
    
    const loginButton = document.getElementById('loginButton');
    const guestLoginButton = document.getElementById('guestLoginButton');
    const continueButton = document.getElementById('continueButton');
    const logoutButtons = document.querySelectorAll('#logoutButton, #logoutButtonSub, #logoutButtonIngreso');
    const backButtons = document.querySelectorAll('#backButtonMain, #backButtonSub, #backButtonIngreso');
    
    const sapEnvSelect = document.getElementById('sapEnvSelect');
    const sapClientInput = document.getElementById('sapClientInput');
    const sapUserInput = document.getElementById('sapUserInput');
    const sapPassInput = document.getElementById('sapPassInput');
    const useSapRouter = document.getElementById('useSapRouter');
    const loginStatus = document.getElementById('loginStatus');
    
    const loggedInUserDisplays = document.querySelectorAll('#loggedInUserDisplay, #loggedInUserDisplaySub, #loggedInUserDisplayIngreso');
    
    const headerDataSection = document.getElementById('headerDataSection');
    const clMovimientoInput = document.getElementById('clMovimiento');
    const almacenInput = document.getElementById('almacen');
    const centroInput = document.getElementById('centro');
    const fechaContabInput = document.getElementById('fechaContab');
    const specialStockIndicatorInput = document.getElementById('specialStockIndicator');
    const textoCabeceraInput = document.getElementById('textoCabecera');
    const reservaCheckboxContainer = document.getElementById('reservaCheckboxContainer');
    const reservaCheckbox = document.getElementById('reservaCheckbox');
    const qrContentElement = document.getElementById("qr-content");
    const scanStatusElement = document.getElementById("scan-status");
    const resetButton = document.getElementById("reset-button");
    const saveButton = document.getElementById("save-button");
    const layoutButtonMseg = document.getElementById('layoutButtonMseg');
    const msegTableBody = document.getElementById("msegTableBody");
    const readerMessageElement = document.querySelector('#reader .qr-message');
    const headerInputs = [clMovimientoInput, almacenInput, centroInput, fechaContabInput, specialStockIndicatorInput];
    const startScanButton = document.getElementById('startScanButton');

    const sublocationReader = document.getElementById('sublocationReader');
    const sublocationScanStatus = document.getElementById('sublocationScanStatus');
    const sublocationTableBody = document.getElementById('sublocationTableBody');
    const sublocationCentroInput = document.getElementById('sublocationCentro');
    const sublocationAlmacenInput = document.getElementById('sublocationAlmacen');
    const sublocationAreaContainer = document.getElementById('sublocationAreaContainer');
    const sublocationReaderMessage = document.querySelector('#sublocationReader .qr-message');
    const sublocationQrContent = document.getElementById('sublocationQrContent');
    const filterInput = document.getElementById('filterInput');
    const exportToExcelButton = document.getElementById('exportToExcelButton');
    const startSublocationScanButton = document.getElementById('startSublocationScanButton');
    const layoutButtonSub = document.getElementById('layoutButtonSub');

    const ingresoNroPedidoInput = document.getElementById('ingresoNroPedido');
    const ingresoItemsTableBody = document.getElementById('ingresoItemsTableBody');
    const ingresoSaveButton = document.getElementById('ingresoSaveButton');
    const ingresoClearButton = document.getElementById('ingresoClearButton');
    const ingresoStatus = document.getElementById('ingresoStatus');
    const selectAllIngresoItemsCheckbox = document.getElementById('selectAllIngresoItemsCheckbox');

    const searchHelpModalElement = document.getElementById('searchHelpModal');
    const searchHelpModal = new bootstrap.Modal(searchHelpModalElement);
    const searchHelpModalLabel = document.getElementById('searchHelpModalLabel');
    const searchHelpFilter = document.getElementById('searchHelpFilter');
    const searchHelpTableHead = document.getElementById('searchHelpTableHead');
    const searchHelpTableBody = document.getElementById('searchHelpTableBody');

    // --- FUNCIONES DEL SPINNER ---
    function showSpinner() { spinner.style.display = 'flex'; }
    function hideSpinner() { spinner.style.display = 'none'; }

    // --- FUNCIONES DE SONIDO (SIN ERRORES SI FALLA) ---
    function playSound(type) {
        // En una arquitectura separada (GitHub Pages), los sonidos necesitarían
        // estar en el mismo repositorio y usar rutas relativas. Por simplicidad,
        // esta funcionalidad se puede omitir o implementar más tarde.
        console.log(`Intento de reproducir sonido: ${type}`);
    }

    // --- REGISTRO DE EVENTOS ---
    loginButton.addEventListener('click', () => handleLogin(false));
    guestLoginButton.addEventListener('click', () => handleLogin(true));
    logoutButtons.forEach(btn => btn.addEventListener('click', handleLogout));
    continueButton.addEventListener('click', handleModeSelection);
    backButtons.forEach(btn => btn.addEventListener('click', goBackToModeSelection));
    
    document.getElementById('searchPoButton').addEventListener('click', fetchPurchaseOrderItems);
    ingresoClearButton.addEventListener('click', () => clearIngresoForm(true));
    ingresoSaveButton.addEventListener('click', saveIngresoData);
    
    document.querySelectorAll('input[name="ingresoStockEspecial"]').forEach(radio => {
        radio.addEventListener('change', updateIngresoTableVisibility);
    });

    // --- LÓGICA DE LOGIN Y SELECCIÓN DE MODO ---
    async function handleLogin(isGuest) {
        isGuestMode = isGuest;
        setLoginStatus(getText('validating'), "info");
        showSpinner();
        
        sapConnection = null;
        const selectedOption = sapEnvSelect.options[sapEnvSelect.selectedIndex];
        const connectionParamsForThisAttempt = {
            ashost: selectedOption.dataset.host,
            sysnr: selectedOption.dataset.sysnr,
            client: sapClientInput.value.trim(),
        };
        if (useSapRouter.checked) {
            connectionParamsForThisAttempt.saprouter = SAP_ROUTER_STRING;
        }
        if (!isGuest) {
            connectionParamsForThisAttempt.user = sapUserInput.value.trim();
            connectionParamsForThisAttempt.passwd = sapPassInput.value.trim();
        }
        
        const endpoint = isGuest ? '/validateGuestLogin' : '/validateLogin';

        try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ connection_params: connectionParamsForThisAttempt })
            });
            const result = await response.json();

            if (result.success) {
                sapConnection = connectionParamsForThisAttempt;
                const userToShow = isGuest ? (result.guest_user || 'Invitado') : connectionParamsForThisAttempt.user;
                
                loginSection.style.display = 'none';
                modeSelectionSection.style.display = 'block';
                const userDisplayText = `${getText('user')}: ${userToShow} (${sapEnvSelect.value})`;
                loggedInUserDisplays.forEach(el => el.textContent = userDisplayText);
            } else {
                sapConnection = null;
                setLoginStatus(`Error: ${result.error}`, 'error');
                playSound('error');
            }
        } catch (e) {
            sapConnection = null;
            setLoginStatus(`${getText('networkError')}: ${e.message}`, 'error');
            playSound('error');
        } finally {
            hideSpinner();
        }
    }

    async function handleLogout() {
        sapConnection = null; 
        isGuestMode = false;
        
        mainContent.style.display = 'none';
        sublocationContent.style.display = 'none';
        ingresoContent.style.display = 'none';
        modeSelectionSection.style.display = 'none';
        loginSection.style.display = 'block';
        
        sapPassInput.value = '';
        setLoginStatus(getText('sessionClosed'), "info");
        clearAllScreens();
    }

    function handleModeSelection() {
        const selectedMode = document.querySelector('input[name="appMode"]:checked').value;
        modeSelectionSection.style.display = 'none';

        if (selectedMode === 'etiqueta') {
             // Lógica para modo etiqueta si se necesita
        } else if (selectedMode === 'sublocation') {
             // Lógica para modo sub-ubicación si se necesita
        } else if (selectedMode === 'ingreso') {
            ingresoContent.style.display = 'block';
            document.getElementById('ingresoFechaDoc').valueAsDate = new Date();
            document.getElementById('ingresoFechaCont').valueAsDate = new Date();
            updateIngresoTableVisibility();
        }
    }

    async function goBackToModeSelection() {
        mainContent.style.display = 'none';
        sublocationContent.style.display = 'none';
        ingresoContent.style.display = 'none';
        modeSelectionSection.style.display = 'block';
        clearAllScreens();
    }
    
    function setLoginStatus(message, type) {
        loginStatus.textContent = message;
        loginStatus.className = `mt-3 text-center message-${type}`;
    }

    // --- LÓGICA PARA INGRESO DE MATERIALES POR PEDIDO---
    
    function updateIngresoTableVisibility() {
        const stockType = document.querySelector('input[name="ingresoStockEspecial"]:checked').value;
        const wbsCols = document.querySelectorAll('.wbs-col');
        const soCols = document.querySelectorAll('.so-col');

        wbsCols.forEach(el => el.style.display = (stockType === 'Q' ? '' : 'none'));
        soCols.forEach(el => el.style.display = (stockType === 'E' ? '' : 'none'));
    }

    async function fetchPurchaseOrderItems() {
        const poNumber = ingresoNroPedidoInput.value.trim();
        if (!poNumber) {
            clearIngresoForm(false);
            return;
        }
        setIngresoStatus(`Buscando pedido ${poNumber}...`, 'info');
        showSpinner();
        try {
            const response = await fetch(`${API_BASE_URL}/getPurchaseOrderItems`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    connection_params: sapConnection,
                    po_number: poNumber,
                    is_guest: isGuestMode
                })
            });
            const result = await response.json();
            if (result.success && result.items.length > 0) {
                poItemsData = result.items;
                renderIngresoItemsTable(result.items);
                setIngresoStatus(`${result.items.length} posiciones cargadas.`, 'success');
                ingresoSaveButton.disabled = true; // Deshabilitado hasta que se seleccione algo
                playSound('beep');
            } else {
                throw new Error(result.error || 'No se encontraron posiciones para este pedido o el pedido no existe.');
            }
        } catch (err) {
            clearIngresoForm(false);
            setIngresoStatus(`Error: ${err.message}`, 'error');
            playSound('error');
        } finally {
            hideSpinner();
        }
    }

    function renderIngresoItemsTable(items) {
        ingresoItemsTableBody.innerHTML = '';
        selectAllIngresoItemsCheckbox.checked = false;
        items.forEach(item => {
            const tr = document.createElement('tr');
            tr.dataset.pos = item.EBELP;
            const sublocationInputId = `sublocation-${item.EBELP}`;
            tr.innerHTML = `
                <td><input type="checkbox" class="form-check-input item-checkbox" data-pos="${item.EBELP}"></td>
                <td>${item.EBELP}</td>
                <td class="material-cell">${item.MATNR}</td>
                <td>${item.TXZ01}</td>
                <td class="wbs-col">${item.PS_PSP_PNR_D || ''}</td>
                <td class="so-col">${item.KDAUF || ''}</td>
                <td class="so-col">${item.KDPOS || ''}</td>
                <td class="plant-cell">${item.WERKS}</td>
                <td><input type="text" class="form-control form-control-sm" name="almacen" value="${item.LGORT || ''}"></td>
                <td><input type="number" class="form-control form-control-sm" name="cantidad" value="${item.MENGE || 0}"></td>
                <td class="um-cell">${item.MEINS}</td>
                <td><input type="text" class="form-control form-control-sm" name="lote"></td>
                <td>
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" name="sublocation" id="${sublocationInputId}">
                        <button class="btn btn-outline-secondary search-subloc-btn" type="button" data-werks="${item.WERKS}" data-target-id="${sublocationInputId}"><i class="bi bi-search"></i></button>
                    </div>
                </td>
                <td><input type="file" class="form-control form-control-sm" name="certificado" data-pos="${item.EBELP}"></td>
                <td><input type="file" class="form-control form-control-sm" name="documentos" data-pos="${item.EBELP}"></td>
                <td><input type="file" class="form-control form-control-sm" name="inspeccion" data-pos="${item.EBELP}"></td>
            `;
            ingresoItemsTableBody.appendChild(tr);
        });
        updateIngresoTableVisibility();
    }

    async function saveIngresoData() {
        const selectedItems = [];
        ingresoItemsTableBody.querySelectorAll('.item-checkbox:checked').forEach(checkbox => {
            const tr = checkbox.closest('tr');
            const pos = tr.dataset.pos;
            selectedItems.push({
                posicion: pos,
                almacen: tr.querySelector('[name="almacen"]').value,
                cantidad: tr.querySelector('[name="cantidad"]').value,
                lote: tr.querySelector('[name="lote"]').value,
                sublocation: tr.querySelector('[name="sublocation"]').value
            });
        });

        if (selectedItems.length === 0) {
            alert('Debe seleccionar al menos una posición para guardar.');
            return;
        }

        setIngresoStatus('Preparando datos para guardar...', 'info');
        showSpinner();
        
        const headerData = {
            nro_pedido: document.getElementById('ingresoNroPedido').value,
            tipo_movimiento: document.getElementById('ingresoTipoMovimiento').value,
            stock_especial: document.querySelector('input[name="ingresoStockEspecial"]:checked').value,
            fecha_doc: document.getElementById('ingresoFechaDoc').value,
            fecha_cont: document.getElementById('ingresoFechaCont').value,
            material_slip: document.getElementById('ingresoMaterialSlip').value,
            item_adopted: document.getElementById('ingresoItemAdopted').checked,
            texto_cabecera: document.getElementById('ingresoTextoCabecera').value,
        };

        const formData = new FormData();
        const payload = {
            connection_params: sapConnection,
            is_guest: isGuestMode,
            header: headerData,
            items: selectedItems
        };
        formData.append('json_data', JSON.stringify(payload));

        const fileMetadata = [];
        ingresoItemsTableBody.querySelectorAll('.item-checkbox:checked').forEach(checkbox => {
            const tr = checkbox.closest('tr');
            const pos = tr.dataset.pos;
            const certFile = tr.querySelector('[name="certificado"]').files[0];
            const docFile = tr.querySelector('[name="documentos"]').files[0];
            const inspFile = tr.querySelector('[name="inspeccion"]').files[0];

            if (certFile) { formData.append('files[]', certFile); fileMetadata.push({ posicion: pos, field: 'certificado', filename: certFile.name }); }
            if (docFile) { formData.append('files[]', docFile); fileMetadata.push({ posicion: pos, field: 'documentos', filename: docFile.name }); }
            if (inspFile) { formData.append('files[]', inspFile); fileMetadata.push({ posicion: pos, field: 'inspeccion', filename: inspFile.name }); }
        });
        formData.append('file_metadata', JSON.stringify(fileMetadata));

        try {
            const response = await fetch(`${API_BASE_URL}/saveIngreso`, { method: 'POST', body: formData });
            const result = await response.json();

            if (result.success) {
                let msg = `¡Éxito! Documento de material ${result.doc_number} creado.`;
                if(result.warning) { msg += `\n\nADVERTENCIA:\n${result.warning}`}
                setIngresoStatus(msg, result.warning ? 'warning' : 'success');
                playSound('beep');
                alert(msg);
                clearIngresoForm(true);
            } else {
                throw new Error(result.error);
            }

        } catch(err) {
            setIngresoStatus(`Error al guardar: ${err.message}`, 'error');
            playSound('error');
            alert(`Error al guardar: ${err.message}`);
        } finally {
            hideSpinner();
        }
    }

    function clearIngresoForm(clearAll = true) {
        if(clearAll) {
            document.getElementById('ingresoNroPedido').value = '';
            document.getElementById('stockSin').checked = true;
        }
        ingresoItemsTableBody.innerHTML = '';
        ingresoSaveButton.disabled = true;
        setIngresoStatus('', 'info');
        selectAllIngresoItemsCheckbox.checked = false;
        updateIngresoTableVisibility();
    }
    
    function setIngresoStatus(message, type) {
        ingresoStatus.textContent = message;
        ingresoStatus.className = `mt-3 text-center message-${type}`;
    }
    
    function clearAllScreens() {
        // Limpiar pantalla de Ingreso
        clearIngresoForm(true);
        // Limpiar otras pantallas si es necesario
    }
    
    // Delegación de eventos para checkboxes de la tabla de ingreso
    ingresoItemsTableBody.addEventListener('change', (e) => {
        if (e.target.classList.contains('item-checkbox')) {
            const checkedCheckboxes = ingresoItemsTableBody.querySelectorAll('.item-checkbox:checked').length;
            ingresoSaveButton.disabled = checkedCheckboxes === 0;
            const totalCheckboxes = ingresoItemsTableBody.querySelectorAll('.item-checkbox').length;
            selectAllIngresoItemsCheckbox.checked = (totalCheckboxes > 0 && checkedCheckboxes === totalCheckboxes);
        }
    });

    selectAllIngresoItemsCheckbox.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        ingresoItemsTableBody.querySelectorAll('.item-checkbox').forEach(checkbox => checkbox.checked = isChecked);
        const totalCheckboxes = ingresoItemsTableBody.querySelectorAll('.item-checkbox').length;
        ingresoSaveButton.disabled = !isChecked || totalCheckboxes === 0;
    });

    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

});
</script>
</body>
</html>

