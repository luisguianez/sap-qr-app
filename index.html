<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Entradas con Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 95%; margin-top: 2rem; }
        #reader, #sublocationReader { width: 100%; max-width: 450px; margin: 0 auto; border: 2px dashed #ccc; border-radius: 8px; }
        .qr-message, #scan-status, #sublocationScanStatus { text-align: center; }
        .message-success { color: #198754; font-weight: bold; }
        .message-error { color: #dc3545; font-weight: bold; }
        .message-warning { color: #ffc107; font-weight: bold; }
        .table-responsive { max-height: 60vh; }
        #msegTable td input[type="text"], #sublocationTable td, #ingresoItemsTable td input, #ingresoItemsTable td select { font-size: 0.85em; white-space: nowrap; }
        #msegTable .filename-display { background-color: #e9ecef !important; border-radius: 4px; padding: 2px 5px; }
        .checkbox-container { display: none; }
        .checkbox-container.visible { display: flex; align-items: end; }
        #sublocationTable thead th, #msegTable thead th {
            cursor: pointer;
            position: relative;
        }
        #sublocationTable thead th .sort-arrow, #msegTable thead th .sort-arrow {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
        }
      
        #spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1070;
            display: none;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>
<div id="spinner-overlay">
    <div class="spinner-border text-light" role="status">
        <span class="visually-hidden" data-translate="loading">Cargando...</span>
    </div>
</div>

<div class="container">
    <div id="loginSection">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body shadow-sm">
                        <h3 class="card-title text-center mb-4" data-translate="loginTitle">Login SAP</h3>
                        <div class="mb-3">
                            <label for="sapEnvSelect" class="form-label" data-translate="sapEnvironmentLabel">Entorno SAP</label>
                            <select class="form-select" id="sapEnvSelect">
                                <option value="PRD" data-host="172.16.17.32" data-sysnr="00" data-translate="prdEnvironment">Producción (PRD)</option>
                                <option value="QAS" data-host="172.16.16.10" data-sysnr="00" data-translate="qasEnvironment">Calidad (QAS)</option>
                                <option value="DEV" data-host="172.16.16.11" data-sysnr="00" data-translate="devEnvironment">Desarrollo (DEV)</option>
                            </select>
                        </div>
                        <div class="mb-3"><label for="sapClientInput" class="form-label" data-translate="clientLabel">Mandante</label><input type="text" class="form-control" id="sapClientInput"></div>
                        <div class="mb-3"><label for="sapUserInput" class="form-label" data-translate="userLabel">Usuario SAP</label><input type="text" class="form-control" id="sapUserInput"></div>
                        <div class="mb-3"><label for="sapPassInput" class="form-label" data-translate="passwordLabel">Contraseña</label><input type="password" class="form-control" id="sapPassInput"></div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="useSapRouter">
                            <label class="form-check-label" for="useSapRouter" data-translate="useSapRouterLabel">Usar SAP Router</label>
                        </div>
                        <div class="d-grid gap-2">
                            <button id="loginButton" class="btn btn-primary" data-translate="loginButton">Login</button>
                            <button id="guestLoginButton" class="btn btn-secondary" data-translate="guestLoginButton">Login de Invitado</button>
                        </div>
                        <p id="loginStatus" class="mt-3 text-center"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modeSelectionSection" style="display: none;">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body shadow-sm">
                        <h3 class="card-title text-center mb-4" data-translate="selectModeTitle">Seleccione un Modo</h3>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="appMode" id="modeEtiqueta" value="etiqueta" checked>
                            <label class="form-check-label" for="modeEtiqueta" data-translate="labelReadingMode">
                                Lectura de Etiqueta (QR)
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="appMode" id="modeSublocation" value="sublocation">
                            <label class="form-check-label" for="modeSublocation" data-translate="sublocationQueryMode">
                                Consulta por Sub-Ubicación
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="appMode" id="modeIngreso" value="ingreso">
                            <label class="form-check-label" for="modeIngreso" data-translate="goodsReceiptMode">Ingreso de Materiales por Pedido</label>
                        </div>
                        <div class="d-grid gap-2 mt-4">
                            <button id="continueButton" class="btn btn-primary" data-translate="continueButton">Continuar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="mainContent" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="mb-0" data-translate="mainContentTitle">Captura de Movimientos (Lectura QR)</h2>
            <div>
                <button id="backButtonMain" class="btn btn-secondary me-2" data-translate="backButton">Volver</button>
                <span id="loggedInUserDisplay" class="badge bg-success me-3"></span>
                <button id="logoutButton" class="btn btn-danger" data-translate="logoutButton">Logout</button>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-7" id="headerDataSection">
                <div class="p-3 border rounded bg-light mb-4">
                    <h4 class="mb-3" data-translate="headerDataTitle">Datos de Cabecera</h4>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="clMovimiento" data-translate="moveTypeLabel">Cl.Movimiento:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="clMovimiento">
                                <button class="btn btn-outline-secondary" type="button" id="searchClMovimiento"><i class="bi bi-search"></i></button>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label for="specialStockIndicator" data-translate="specialStockLabel">Stock Especial:</label>
                             <div class="input-group">
                                <input type="text" class="form-control" id="specialStockIndicator">
                                <button class="btn btn-outline-secondary" type="button" id="searchSpecialStock"><i class="bi bi-search"></i></button>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label for="centro" data-translate="plantLabel">Centro:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="centro">
                                <button class="btn btn-outline-secondary" type="button" id="searchCentro"><i class="bi bi-search"></i></button>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label for="almacen" data-translate="storageLocationLabel">Almacén:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="almacen">
                                <button class="btn btn-outline-secondary" type="button" id="searchAlmacen"><i class="bi bi-search"></i></button>
                            </div>
                        </div>
                        <div class="col-md-8"><label for="textoCabecera" data-translate="headerTextLabel">Texto Cabecera:</label><input type="text" class="form-control" id="textoCabecera"  maxlength="25"></div>
                        <div class="col-md-6"><label for="fechaContab" data-translate="postingDateLabel">Fecha Contab.:</label><input type="date" class="form-control" id="fechaContab"></div>
                        <div class="col-md-6 checkbox-container" id="reservaCheckboxContainer">
                            <div class="form-check pt-4"><input class="form-check-input" type="checkbox" id="reservaCheckbox"><label class="form-check-label" for="reservaCheckbox" data-translate="reservationLabel">Reserva</label></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-5">
                <label for="qr-content" data-translate="lastQrLabel">Último QR leído:</label>
                <p id="qr-content" class="form-control-plaintext border p-2 bg-light rounded mb-2"></p>
                <div id="reader" style="display: none;"><span class="qr-message p-3"></span></div>
                <button id="startScanButton" class="btn btn-primary mt-2" data-translate="activateCameraButton">Activar Cámara</button>
                <button id="stopScanButton" class="btn btn-danger mt-2" style="display: none;" data-translate="stopCameraButton">Detener Cámara</button>
                <p id="scan-status" class="lead mt-2"></p>
            </div>
        </div>
        <div class="text-center my-3">
            <button id="reset-button" class="btn btn-warning me-2" style="display: none;" data-translate="clearButton">Limpiar</button>
            <button id="save-button" class="btn btn-success" style="display: none;" data-translate="saveButton">Guardar en SAP</button>
            <button id="layoutButtonMseg" class="btn btn-info" style="display: none;" data-bs-toggle="tooltip" title="Seleccionar Columnas"><i class="bi bi-layout-three-columns"></i></button>
        </div>
        <div class="table-responsive">
            <table id="msegTable" class="table table-bordered table-striped table-sm">
                <thead><tr>
                    <th data-column="docCol" data-translate="docCol">Documento</th>
                    <th data-column="yearCol" data-translate="yearCol">Año</th>
                    <th data-column="posCol" data-translate="posCol">Pos.</th>
                    <th data-column="materialCol" data-translate="materialCol">Material</th>
                    <th data-column="materialDescCol" data-translate="materialDescCol"  style="min-width: 230px;">Texto Material</th>
                    <th data-column="qtyCol" data-translate="qtyCol">Cantidad</th>
                    <th data-column="unitCol" data-translate="unitCol">Unidad</th>
                    <th data-column="batchCol" data-translate="batchCol">Lote</th>
                    <th data-column="certCol" style="min-width: 200px;" data-translate="certCol">Certificado</th>
                    <th data-column="docsCol" style="min-width: 200px;" data-translate="docsCol">Documentos</th>
                    <th data-column="inspCol" style="min-width: 200px;" data-translate="inspCol">Inspección</th>
                    <th data-column="itemTextCol" style="min-width: 150px;" data-translate="itemTextCol">Texto Pos.</th>
                    <th data-column="tagCol" data-translate="tagCol">TAG</th>
                    <th data-column="subLocCol" data-translate="subLocCol" style="min-width: 180px;">Sub Ubicacion</th>
                    <th data-column="areaCol" style="min-width: 150px;" data-translate="areaCol">Área</th>
                    <th data-column="orderNoCol" data-translate="orderNoCol">Nro. Pedido</th>
                    <th data-column="orderNo2Col" class="d-none" data-translate="orderNo2Col">Pedido 2</th>
                    <th data-column="wbsCol" data-translate="wbsCol">Elemento PEP</th>
                    <th data-column="reservationCol" class="reserva-col d-none" data-translate="reservationCol">Reserva</th>
                    <th data-column="salesOrderCol" data-translate="salesOrderCol">Pedido Cliente</th>
                    <th data-column="salesOrderItemCol" data-translate="salesOrderItemCol">Pos. Pedido Cliente</th>
                </tr></thead>
                <tbody id="msegTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="sublocationContent" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="mb-0" data-translate="sublocationQueryTitle">Consulta por Sub-Ubicación</h2>
            <div>
                <button id="backButtonSub" class="btn btn-secondary me-2" data-translate="backButton">Volver</button>
                <span id="loggedInUserDisplaySub" class="badge bg-success me-3"></span>
                <button id="logoutButtonSub" class="btn btn-danger" data-translate="logoutButton">Logout</button>
            </div>
        </div>
        <div class="p-3 border rounded bg-light mb-4">
            <div class="row align-items-end">
                <div class="col-lg-8">
                    <h4 class="mb-3" data-translate="searchFiltersTitle">Filtros de Búsqueda</h4>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="sublocationCentro" data-translate="plantLabel">Centro:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="sublocationCentro">
                                <button class="btn btn-outline-secondary" type="button" id="searchSublocationCentro"><i class="bi bi-search"></i></button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="sublocationAlmacen" data-translate="storageLocationLabel">Almacén:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="sublocationAlmacen">
                                <button class="btn btn-outline-secondary" type="button" id="searchSublocationAlmacen"><i class="bi bi-search"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="row g-3 mt-2" id="sublocationAreaContainer" style="display: none;">
                        <div class="col-12">
                            <label class="form-label" data-translate="areaLabel">Área:</label>
                            <div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="sublocationArea" id="areaTodos" value="00" checked><label class="form-check-label" for="areaTodos" data-translate="allLabel">Todos</label></div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="sublocationArea" id="area01" value="01"><label class="form-check-label" for="area01">01</label></div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="sublocationArea" id="area02" value="02"><label class="form-check-label" for="area02">02</label></div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="sublocationArea" id="area03" value="03"><label class="form-check-label" for="area03">03</label></div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="sublocationArea" id="area04" value="04"><label class="form-check-label" for="area04">04</label></div>
                                <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="sublocationArea" id="area05" value="05"><label class="form-check-label" for="area05">05</label></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <label for="sublocationQrContent" data-translate="lastQrLabel">Último QR leído:</label>
                    <p id="sublocationQrContent" class="form-control-plaintext border p-2 bg-light rounded mb-2"></p>
                    <div id="sublocationReader" style="display: none;"><span class="qr-message p-3"></span></div>
                    <button id="startSublocationScanButton" class="btn btn-primary mt-2" data-translate="activateCameraButton">Activar Cámara</button>
                    <button id="stopSublocationScanButton" class="btn btn-danger mt-2" style="display: none;" data-translate="stopCameraButton">Detener Cámara</button>
                    <p id="sublocationScanStatus" class="lead mt-2"></p>
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="mt-4" data-translate="searchResultsTitle">Resultados de la Búsqueda</h4>
            <div class="d-flex align-items-center">
                <input type="text" id="filterInput" class="form-control me-2" placeholder="Filtrar resultados..." data-translate="filterPlaceholder">
                <button id="exportToExcelButton" class="btn btn-success"><i class="bi bi-file-earmark-excel"></i></button>
                <button id="layoutButtonSub" class="btn btn-info ms-2" data-bs-toggle="tooltip" title="Seleccionar Columnas"><i class="bi bi-layout-three-columns"></i></button>
            </div>
        </div>
        <div class="table-responsive mt-2">
            <table id="sublocationTable" class="table table-bordered table-striped table-sm">
                <thead id="sublocationTableHead">
                    <tr>
                        <th data-column="MATNR">Material <span class="sort-arrow"></span></th>
                        <th data-column="MAKTX">Descripción <span class="sort-arrow"></span></th>
                        <th data-column="WERKS">Centro <span class="sort-arrow"></span></th>
                        <th data-column="LGORT">Almacén <span class="sort-arrow"></span></th>
                        <th data-column="CHARG">Lote <span class="sort-arrow"></span></th>
                        <th data-column="SOBKZ">Ind. Stock Esp. <span class="sort-arrow"></span></th>
                        <th data-column="KZBWS">Val. Stock Esp. <span class="sort-arrow"></span></th>
                        <th data-column="PS_PSP_PNR">Elemento PEP <span class="sort-arrow"></span></th>
                        <th data-column="ZZUBICACION">TAG <span class="sort-arrow"></span></th>
                        <th data-column="ZZSUB_UBICACION">Sub Ubicación <span class="sort-arrow"></span></th>
                        <th data-column="ZZ_PAIS">Pais <span class="sort-arrow"></span></th>
                        <th data-column="MEINS">Unidada de Medida <span class="sort-arrow"></span></th>
                        <th data-column="WAERS">Moneda <span class="sort-arrow"></span></th>
                        <th data-column="LABST">Stock Libre <span class="sort-arrow"></span></th>
                        <th data-column="WLABS">Valor Libre <span class="sort-arrow"></span></th>
                        <th data-column="UMLME">Stock Traslado <span class="sort-arrow"></span></th>
                        <th data-column="WUMLM">Valor Traslado <span class="sort-arrow"></span></th>
                        <th data-column="INSME">Stock Calidad <span class="sort-arrow"></span></th>
                        <th data-column="WINSM">Valor Calidad <span class="sort-arrow"></span></th>
                        <th data-column="EINME">Stock No Libre <span class="sort-arrow"></span></th>
                        <th data-column="WEINM">Valor No Libre <span class="sort-arrow"></span></th>
                        <th data-column="SPEME">Stock Bloqueado <span class="sort-arrow"></span></th>
                        <th data-column="WSPEM">Valor Bloqueado <span class="sort-arrow"></span></th>
                        <th data-column="RETME">Stock Devolución <span class="sort-arrow"></span></th>
                        <th data-column="WRETM">Valor Devolución <span class="sort-arrow"></span></th>
                    </tr>
                </thead>
                <tbody id="sublocationTableBody">
                </tbody>
            </table>
        </div>
    </div>

<div id="ingresoContent" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0" data-translate="ingresoTitle">Ingreso de Materiales por Pedido</h2>
        <div>
            <button id="backButtonIngreso" class="btn btn-secondary me-2" data-translate="backButton">Volver</button>
            <span id="loggedInUserDisplayIngreso" class="badge bg-success me-3"></span>
            <button id="logoutButtonIngreso" class="btn btn-danger" data-translate="logoutButton">Logout</button>
        </div>
    </div>
    <div class="card">
        <div class="card-body">
            <h4 class="mb-3" data-translate="headerDataTitle">Datos de Cabecera</h4>
            <div class="row g-3 p-3 border rounded bg-light mb-4">
                <div style="width: 350px;">
                    <label for="ingresoNroPedido" class="form-label" data-translate="poNumberLabel">Nro de Pedido</label>
          <div class="input-group">
    <input type="text" class="form-control" id="ingresoNroPedido">
    <button class="btn btn-primary" type="button" id="searchPoButton">
        <i class="bi bi-search"></i>
        <span class="d-none d-sm-inline" data-translate="searchPOButton"> Buscar Pedido</span>
    </button>
</div>
                </div>
                <div class="col-md-2"><label for="ingresoTipoMovimiento" class="form-label" data-translate="moveTypeLabel">Tipo de Movimiento</label><input type="text" class="form-control" id="ingresoTipoMovimiento" value="101" readonly></div>
                <div class="col-md-4">
                   
                
                        
                </div>
                <div class="col-md-3"><label for="ingresoFechaDoc" class="form-label" data-translate="docDateLabel">Fecha de Documento</label><input type="date" class="form-control" id="ingresoFechaDoc"></div>
                <div class="col-md-3"><label for="ingresoFechaCont" class="form-label" data-translate="postingDateLabel">Fecha de Contabilización</label><input type="date" class="form-control" id="ingresoFechaCont"></div>
                <div class="col-md-3"><label for="ingresoMaterialSlip" class="form-label" data-translate="materialSlipLabel">Material Slip</label><input type="text" class="form-control" id="ingresoMaterialSlip"></div>
                <div class="col-md-3"><label for="ingresoTextoCabecera" class="form-label" data-translate="headerTextLabel">Texto de Cabecera</label><input type="text" class="form-control" id="ingresoTextoCabecera"  maxlength="25"></div>
            </div>
            <h4 class="mb-3 mt-4" data-translate="poItemsTitle">Posiciones del Pedido</h4>
            <div class="table-responsive">
 <table id="ingresoItemsTable" class="table table-bordered table-sm">
    <thead>
        <tr>
            <th><input type="checkbox" id="selectAllIngresoItemsCheckbox"></th>
            <th data-translate="posCol">Pos.</th>
            <th data-translate="specialStockLabel">Ind. Stock Esp.</th>
            <th data-translate="materialCol">Material</th>
            <th data-translate="materialDescCol">Descripción</th>
            <th class="wbs-col" data-translate="wbsCol">Elemento PEP (WBS)</th>
            <th class="so-col" data-translate="salesOrderHeader">Pedido Venta</th>
            <th class="so-col" data-translate="salesOrderItemHeader">Pos. Ped. Venta</th>
            <th data-translate="plantLabel">Planta</th>
            <th data-translate="storageLocationLabel">Almacén</th>
            <th data-translate="qtyCol">Cantidad</th>
            <th data-translate="unitCol">UM</th>
            <th data-translate="batchCol" style="min-width: 100px;">Lote</th>
            <th data-translate="sublocationHeader" style="min-width: 150px;">Sub-Ubicación</th>
            <th style="min-width: 160px;" data-translate="tagCol">TAG</th>
            <th style="min-width: 80px;" data-translate="countryHeader">País</th>
            <th style="min-width: 200px;" data-translate="itemTextHeader">Texto Posición</th>
            <th data-translate="certCol">Certificado</th>
            <th data-translate="docsCol">Documentos</th>
            <th data-translate="inspCol">Inspección</th>
        </tr>
    </thead>
    <tbody id="ingresoItemsTableBody"></tbody>
</table>
            </div>
            <hr>
            <div class="text-center">
                <button id="ingresoClearButton" class="btn btn-warning me-2" data-translate="clearButton">Limpiar</button>
                <button id="ingresoSaveButton" class="btn btn-success" disabled data-translate="saveButton">Guardar en SAP</button>
                <button id="printLabelsButton" class="btn btn-info" style="display: none;">
                    <i class="bi bi-printer"></i> <span data-translate="printLabelsButton">Imprimir Etiquetas</span>
                </button>
                 <button id="printDocMaterialButton" class="btn btn-primary" style="display: none;">
                    <i class="bi bi-file-earmark-pdf"></i> <span data-translate="printMaterialDocButton">Imprimir Doc. Material</span>
                </button>
            </div>
             <p id="ingresoStatus" class="mt-3 text-center"></p>
        </div>
    </div>
</div>

<div class="modal fade" id="searchHelpModal" tabindex="-1" aria-labelledby="searchHelpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="searchHelpModalLabel" data-translate="searchHelpTitle">Ayuda para Búsqueda</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="searchHelpFilter" class="form-control mb-3" placeholder="Filtrar..." data-translate="filterPlaceholder">
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-hover table-sm">
                        <thead id="searchHelpTableHead"></thead>
                        <tbody id="searchHelpTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="signatureModal" tabindex="-1" aria-labelledby="signatureModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="signatureModalLabel" data-translate="additionalConfirmationTitle">Confirmación Adicional</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p data-translate="completeFollowingData">Por favor, complete los siguientes datos para finalizar el guardado.</p>
                <div id="modal-error-message" class="alert alert-danger" style="display: none;"></div>

                <div class="mb-3">
                    <label for="receptorSelect" class="form-label" data-translate="receiverLabel">Receptor:</label>
                    <select id="receptorSelect" class="form-select" required>
                        <option value="" data-translate="loading">Cargando...</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="despachadorSelect" class="form-label" data-translate="dispatcherLabel">Despachador:</label>
                    <select id="despachadorSelect" class="form-select" required>
                        <option value="" data-translate="loading">Cargando...</option>
                    </select>
                </div>

                <div class="mb-3" id="labelSizeContainer">
                    <label for="labelSizeSelect" class="form-label" data-translate="labelSizeLabel">Tamaño de Etiqueta:</label>
                    <select id="labelSizeSelect" class="form-select" required>
                        <option value="" data-translate="selectSize">Seleccione un tamaño...</option>
                        <option value="S" data-translate="smallLabel">S - Pequeña</option>
                        <option value="M" data-translate="mediumLabel">M - Mediana</option>
                        <option value="L" data-translate="largeLabel">L - Grande</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Close" data-translate="cancelButton">Cancelar</button>
                <button type="button" id="confirmSaveButton" class="btn btn-primary" data-translate="confirmAndSaveButton">Confirmar y Guardar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="layoutModal" tabindex="-1" aria-labelledby="layoutModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="layoutModalLabel" data-translate="layoutModalTitle">Seleccionar Columnas Visibles</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="layoutModalBody">
                </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="cancelButton">Cancelar</button>
                <button type="button" id="applyLayoutButton" class="btn btn-primary" data-translate="applyButton">Aplicar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="longTextModal" tabindex="-1" aria-labelledby="longTextModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="longTextModalLabel">Texto Extendido del Material</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre id="longTextModalBody" style="white-space: pre-wrap; word-wrap: break-word;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>


<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const API_BASE_URL = (window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost')
        ? ''
        : 'https://api.lndsap.com';

    const translations = {
        en: {
            // General
            loading: "Loading...",
            user: "User",
            logoutButton: "Logout",
            continueButton: "Continue",
            cancelButton: "Cancel",
            clearButton: "Clear",
            saveButton: "Save to SAP",
            backButton: "Back",
            activateCameraButton: "Activate Camera",
            stopCameraButton: "Stop Camera",
            applyButton: "Apply",
            selectAll: "Select All",
            deselectAll: "Deselect All",
            // Login Screen
            loginTitle: "SAP Login",
            sapEnvironmentLabel: "SAP Environment",
            devEnvironment: "Development (DEV)",
            qasEnvironment: "Quality (QAS)",
            prdEnvironment: "Production (PRD)",
            clientLabel: "Client",
            userLabel: "SAP User",
            passwordLabel: "Password",
            useSapRouterLabel: "Use SAP Router",
            guestLoginButton: "Guest Login",
            // Mode Selection
            selectModeTitle: "Select a Mode",
            labelReadingMode: "Label Reading (QR)",
            sublocationQueryMode: "Query by Sublocation",
            goodsReceiptMode: "Goods Receipt by Purchase Order",
            // Label Reading Program
            mainContentTitle: "Movement Capture (QR Reading)",
            headerDataTitle: "Header Data",
            moveTypeLabel: "Move. Type:",
            specialStockLabel: "Special Stock:",
            plantLabel: "Plant:",
            storageLocationLabel: "Storage Loc.:",
            headerTextLabel: "Header Text:",
            postingDateLabel: "Posting Date:",
            reservationLabel: "Reservation",
            lastQrLabel: "Last QR Read:",
            // Sublocation Query Program
            sublocationQueryTitle: "Query by Sublocation",
            searchFiltersTitle: "Search Filters",
            areaLabel: "Area:",
            allLabel: "All",
            scanSublocationQr: "Scan the Sublocation's QR code",
            completeFiltersToScan: "Complete filters to scan.",
            searchResultsTitle: "Search Results",
            filterPlaceholder: "Filter results...",
            // Modals
            searchHelpTitle: "Search Help",
            layoutModalTitle: "Select Visible Columns",
            additionalConfirmationTitle: "Additional Confirmation",
            completeFollowingData: "Please complete the following data to finalize saving.",
            receiverLabel: "Receiver:",
            dispatcherLabel: "Dispatcher:",
            labelSizeLabel: "Label Size:",
            selectSize: "Select a size...",
            smallLabel: "S - Small",
            mediumLabel: "M - Medium",
            largeLabel: "L - Large",
            confirmAndSaveButton: "Confirm and Save",
            // Table Headers
            docCol: "Document", yearCol: "Year", posCol: "Item", materialCol: "Material", materialDescCol: "Material Text", qtyCol: "Quantity",
            unitCol: "Unit", batchCol: "Batch", certCol: "Certificate", docsCol: "Documents", inspCol: "Inspection", itemTextCol: "Item Text",
            tagCol: "TAG", subLocCol: "Sublocation", areaCol: "Area", orderNoCol: "Order No.", orderNo2Col: "Order No. 2",wbsCol: "WBS Element", reservationCol: "Reservation",
            salesOrderCol: "Sales Order", salesOrderItemCol: "SO Item",
            // Sublocation Table Headers
            sublocationCol: "Sublocation", countryCol: "Country", uomCol: "Unit of Measure", currencyCol: "Currency", freeStockCol: "Free Stock",
            freeValueCol: "Free Value", transferStockCol: "Transfer Stock", transferValueCol: "Transfer Value", qualityStockCol: "Quality Stock",
            qualityValueCol: "Quality Value", nonFreeStockCol: "Non-Free Stock", nonFreeValueCol: "Non-Free Value", blockedStockCol: "Blocked Stock",
            blockedValueCol: "Blocked Value", returnsStockCol: "Returns Stock", returnsValueCol: "Returns Value",
            // Dynamic Messages
            validating: "Validating...",
            sessionClosed: "Session closed.",
            readyToScan: "Ready to scan",
            cameraError: "Error starting camera",
            scannerStopped: "Scanner stopped.",
            invalidQrFormat: "Unrecognized QR format.",
            codeAlreadyScanned: "Code already scanned.",
            processing: "Processing...",
            validationSuccess: "Validation successful.",
            networkError: "Network error",
            sessionError: "Session error.",
            loadingData: "Loading data...",
            confirmWindowError: "Could not open confirmation window",
            allFieldsRequired: "All visible fields are required.",
            preparingData: "Preparing data...",
            savingData: "Saving movement and uploading files...",
            processCompleted: "Process completed!",
            saveError: "Error while saving",
            noDataToExport: "No data to export.",
            noFilteredDataToExport: "The current filter returns no results to export.",
            processingSublocation: "Processing sublocation",
            recordsFound: "{count} records found.",
            // Search Help Translations
            searchHelpForPlant: "Search Help - Plant",
            searchHelpForStorage: "Search Help - Storage Location",
            searchHelpForMoveType: "Search Help - Movement Type",
            searchHelpForSpecialStock: "Search Help - Special Stock",
            plantCol: "Plant",
            plantNameCol: "Plant Name",
            storageCol: "Stor. Location",
            storageNameCol: "Location Name",
            moveTypeCol: "Move. Type",
            specialStockCol: "Special Stock",
            // Material Receipt by PO
            ingresoTitle: "Purchase Order Goods Receipt",
            poNumberLabel: "Purchase Order No.",
            searchPOButton: "Search PO",
            noIndicatorLabel: "No Indicator",
            itemAdoptedLabel: "Item Adopted",
            docDateLabel: "Document Date",
            materialSlipLabel: "Material Slip",
            poItemsTitle: "Purchase Order Items",
            salesOrderHeader: "Sales Order",
            salesOrderItemHeader: "SO Item",
            sublocationHeader: "Sublocation",
            countryHeader: "Country",
            itemTextHeader: "Item Text",
            printLabelsButton: "Print Labels",
            searchingPO: "Searching PO",
            itemsLoaded: "items loaded.",
            noItemsFound: "No items found.",
            savingError: "Error while saving",
            successDocCreated: "Success! Document {doc_number} created.",
            labelsGenerated: "Labels generated. You can now clear the form.",
            printMaterialDocButton: "Print Material Doc.",
            generatingMaterialDoc: "Generating Material Document...",
            materialDocGenerated: "Document generated.",
            sublocationRequiredError: "The Sublocation field is mandatory for the selected items. Please fill in the highlighted fields."
        },
        es: {
            // General
            loading: "Cargando...",
            user: "Usuario",
            logoutButton: "Logout",
            continueButton: "Continuar",
            cancelButton: "Cancelar",
            clearButton: "Limpiar",
            saveButton: "Guardar en SAP",
            backButton: "Volver",
            activateCameraButton: "Activar Cámara",
            stopCameraButton: "Detener Cámara",
            applyButton: "Aplicar",
            selectAll: "Marcar todo",
            deselectAll: "Desmarcar todo",
            // Login Screen
            loginTitle: "Login SAP",
            sapEnvironmentLabel: "Entorno SAP",
            devEnvironment: "Desarrollo (DEV)",
            qasEnvironment: "Calidad (QAS)",
            prdEnvironment: "Producción (PRD)",
            clientLabel: "Mandante",
            userLabel: "Usuario SAP",
            passwordLabel: "Contraseña",
            useSapRouterLabel: "Usar SAP Router",
            guestLoginButton: "Login de Invitado",
            // Mode Selection
            selectModeTitle: "Seleccione un Modo",
            labelReadingMode: "Lectura de Etiqueta (QR)",
            sublocationQueryMode: "Consulta por Sub-Ubicación",
            goodsReceiptMode: "Ingreso de Materiales por Pedido",
            // Label Reading Program
            mainContentTitle: "Captura de Movimientos (Lectura QR)",
            headerDataTitle: "Datos de Cabecera",
            moveTypeLabel: "Cl.Movimiento:",
            specialStockLabel: "Stock Especial:",
            plantLabel: "Centro:",
            storageLocationLabel: "Almacén:",
            headerTextLabel: "Texto Cabecera:",
            postingDateLabel: "Fecha Contab.:",
            reservationLabel: "Reserva",
            lastQrLabel: "Último QR leído:",
            // Sublocation Query Program
            sublocationQueryTitle: "Consulta por Sub-Ubicación",
            searchFiltersTitle: "Filtros de Búsqueda",
            areaLabel: "Área:",
            allLabel: "Todos",
            scanSublocationQr: "Escanee el código QR de la Sub-Ubicación",
            completeFiltersToScan: "Complete los filtros para escanear.",
            searchResultsTitle: "Resultados de la Búsqueda",
            filterPlaceholder: "Filtrar resultados...",
            // Modals
            searchHelpTitle: "Ayuda para Búsqueda",
            layoutModalTitle: "Seleccionar Columnas Visibles",
            additionalConfirmationTitle: "Confirmación Adicional",
            completeFollowingData: "Por favor, complete los siguientes datos para finalizar el guardado.",
            receiverLabel: "Receptor:",
            dispatcherLabel: "Despachador:",
            labelSizeLabel: "Tamaño de Etiqueta:",
            selectSize: "Seleccione un tamaño...",
            smallLabel: "S - Pequeña",
            mediumLabel: "M - Mediana",
            largeLabel: "L - Grande",
            confirmAndSaveButton: "Confirmar y Guardar",
            // Table Headers
            docCol: "Documento", yearCol: "Año", posCol: "Pos.", materialCol: "Material", materialDescCol: "Texto Material", qtyCol: "Cantidad",
            unitCol: "Unidad", batchCol: "Lote", certCol: "Certificado", docsCol: "Documentos", inspCol: "Inspección", itemTextCol: "Texto Pos.",
            tagCol: "TAG", subLocCol: "Sub Ubicacion", areaCol: "Área", orderNoCol: "Nro. Pedido", orderNo2Col: "Nro. Pedido 2", wbsCol: "Elemento PEP", reservationCol: "Reserva",
            salesOrderCol: "Pedido Cliente", salesOrderItemCol: "Pos. Pedido Cliente",
            // Sublocation Table Headers
            sublocationCol: "Sub Ubicación", countryCol: "Pais", uomCol: "Unidada de Medida", currencyCol: "Moneda", freeStockCol: "Stock Libre Utilizacion",
            freeValueCol: "Valor Libre Utilizacion", transferStockCol: "Stock Traslado", transferValueCol: "Valor Traslado", qualityStockCol: "Stock Calidad",
            qualityValueCol: "Valor Calidad", nonFreeStockCol: "Stock No Libre", nonFreeValueCol: "Valor No Libre", blockedStockCol: "Stock Bloqueado",
            blockedValueCol: "Valor Bloqueado", returnsStockCol: "Stock Devolución", returnsValueCol: "Valor Devolución",
            // Dynamic Messages
            validating: "Validando...",
            sessionClosed: "Sesión cerrada.",
            readyToScan: "Listo para escanear",
            cameraError: "Error al iniciar cámara",
            scannerStopped: "Escáner detenido.",
            invalidQrFormat: "Formato de QR no reconocido.",
            codeAlreadyScanned: "Código ya escaneado.",
            processing: "Procesando...",
            validationSuccess: "Validación exitosa.",
            networkError: "Error de red",
            sessionError: "Error de sesión.",
            loadingData: "Cargando datos...",
            confirmWindowError: "No se pudo abrir la ventana de confirmación",
            allFieldsRequired: "Todos los campos visibles son obligatorios.",
            preparingData: "Preparando datos...",
            savingData: "Guardando movimiento y subiendo archivos...",
            processCompleted: "¡Proceso completado!",
            saveError: "Error al guardar",
            noDataToExport: "No hay datos para exportar.",
            noFilteredDataToExport: "El filtro actual no devuelve resultados para exportar.",
            processingSublocation: "Procesando sub-ubicación",
            recordsFound: "Se encontraron {count} registros.",
            // Traducciones de Ayuda de Búsqueda
            searchHelpForPlant: "Ayuda para Búsqueda - Centro",
            searchHelpForStorage: "Ayuda para Búsqueda - Almacén",
            searchHelpForMoveType: "Ayuda para Búsqueda - Clase de Movimiento",
            searchHelpForSpecialStock: "Ayuda para Búsqueda - Stock Especial",
            plantCol: "Centro",
            plantNameCol: "Nombre Centro",
            storageCol: "Almacén",
            storageNameCol: "Nombre Almacén",
            moveTypeCol: "Clase Mov.",
            specialStockCol: "Stock Esp.",
            // Ingreso de Materiales por Pedido
            ingresoTitle: "Ingreso de Materiales por Pedido",
            poNumberLabel: "Nro de Pedido",
            searchPOButton: "Buscar Pedido",
            noIndicatorLabel: "Sin Indicador",
            itemAdoptedLabel: "Item Adopted",
            docDateLabel: "Fecha de Documento",
            materialSlipLabel: "Material Slip",
            poItemsTitle: "Posiciones del Pedido",
            salesOrderHeader: "Pedido Venta",
            salesOrderItemHeader: "Pos. Ped. Venta",
            sublocationHeader: "Sub-Ubicación",
            countryHeader: "País",
            itemTextHeader: "Texto Posición",
            printLabelsButton: "Imprimir Etiquetas",
            searchingPO: "Buscando pedido",
            itemsLoaded: "posiciones cargadas.",
            noItemsFound: "No se encontraron posiciones.",
            savingError: "Error al guardar",
            successDocCreated: "¡Éxito! Documento {doc_number} creado.",
            labelsGenerated: "Etiquetas generadas. Puede limpiar el formulario.",
            printMaterialDocButton: "Imprimir Doc. Material",
            generatingMaterialDoc: "Generando Documento de Material...",
            materialDocGenerated: "Documento generado.",
            sublocationRequiredError: "El campo Sub-Ubicación es obligatorio para las posiciones seleccionadas. Por favor, complete los campos marcados en rojo."
        }
    };

    let currentLang = 'es';

    function setLanguage(lang) {
        currentLang = lang;
        document.querySelectorAll('[data-translate]').forEach(el => {
            const key = el.getAttribute('data-translate');
            if (translations[lang] && translations[lang][key]) {
                if (el.placeholder) {
                    el.placeholder = translations[lang][key];
                } else {
                    el.textContent = translations[lang][key];
                }
            }
        });
        document.documentElement.lang = lang;
        const sublocationTable = document.getElementById('sublocationTable');
        if (sublocationTable) {
            const thead = sublocationTable.querySelector('thead');
            thead.querySelectorAll('th').forEach(th => {
                const columnKey = th.dataset.column;
                let translationKey = '';
                if (columnKey === 'MATNR') translationKey = 'materialCol';
                else if (columnKey === 'MAKTX') translationKey = 'materialDescCol';
                else if (columnKey === 'WERKS') translationKey = 'plantLabel';
                else if (columnKey === 'LGORT') translationKey = 'storageLocationLabel';
                else if (columnKey === 'CHARG') translationKey = 'batchCol';
                else if (columnKey === 'SOBKZ') translationKey = 'specialStockLabel';
                else if (columnKey === 'KZBWS') translationKey = 'Val. Stock Esp.';
                else if (columnKey === 'PS_PSP_PNR') translationKey = 'wbsCol';
                else if (columnKey === 'ZZUBICACION') translationKey = 'tagCol';
                else if (columnKey === 'ZZSUB_UBICACION') translationKey = 'sublocationCol';
                else if (columnKey === 'ZZ_PAIS') translationKey = 'countryCol';
                else if (columnKey === 'MEINS') translationKey = 'uomCol';
                else if (columnKey === 'WAERS') translationKey = 'currencyCol';
                else if (columnKey === 'LABST') translationKey = 'freeStockCol';
                else if (columnKey === 'WLABS') translationKey = 'freeValueCol';
                else if (columnKey === 'UMLME') translationKey = 'transferStockCol';
                else if (columnKey === 'WUMLM') translationKey = 'transferValueCol';
                else if (columnKey === 'INSME') translationKey = 'qualityStockCol';
                else if (columnKey === 'WINSM') translationKey = 'qualityValueCol';
                else if (columnKey === 'EINME') translationKey = 'nonFreeStockCol';
                else if (columnKey === 'WEINM') translationKey = 'nonFreeValueCol';
                else if (columnKey === 'SPEME') translationKey = 'blockedStockCol';
                else if (columnKey === 'WSPEM') translationKey = 'blockedValueCol';
                else if (columnKey === 'RETME') translationKey = 'returnsStockCol';
                else if (columnKey === 'WRETM') translationKey = 'returnsValueCol';

                th.childNodes[0].nodeValue = getText(translationKey) + ' ';
            });
        }
    }

    function getText(key, fallback = null) {
        return (translations[currentLang] && translations[currentLang][key]) || fallback || key;
    }

    const userLang = navigator.language.slice(0, 2).toLowerCase();
    setLanguage(userLang === 'es' ? 'es' : 'en');

    // --- VARIABLES GLOBALES ---
    let sapConnection = null;
    let html5QrCode = null;
    let html5QrCodeSublocation = null;
    let isScanning = false;
    let isSublocationScanning = false;
    let isGuestMode = false;
    const scannedCodes = new Map();
    const SAP_ROUTER_STRING = "/H/50.234.28.124/H/";
    const beepSound = new Audio("{{ url_for('static', filename='beep.mp3') }}");
    const errorSound = new Audio("{{ url_for('static', filename='error.mp3') }}");
    let sublocationData = [];
    let sortState = { column: null, direction: 'asc' };
    let currentSearchHelpTarget = null;
    let msegColumnVisibility = {};
    let sublocationColumnVisibility = {};
    let currentLayoutConfig = {};
    let poItemsData = [];
    let currentSaveHandler = null;
    let currentSearchHelpTargetRowInput = null;
    let lastSavedIngresoData = null;

    // --- Referencias al DOM ---
    const spinner = document.getElementById('spinner-overlay');
    const loginSection = document.getElementById('loginSection');
    const modeSelectionSection = document.getElementById('modeSelectionSection');
    const mainContent = document.getElementById('mainContent');
    const sublocationContent = document.getElementById('sublocationContent');
    const ingresoContent = document.getElementById('ingresoContent');
    const loginButton = document.getElementById('loginButton');
    const guestLoginButton = document.getElementById('guestLoginButton');
    const continueButton = document.getElementById('continueButton');
    const logoutButtons = document.querySelectorAll('#logoutButton, #logoutButtonSub, #logoutButtonIngreso');
    const backButtons = document.querySelectorAll('#backButtonMain, #backButtonSub, #backButtonIngreso');
    const sapEnvSelect = document.getElementById('sapEnvSelect');
    const sapClientInput = document.getElementById('sapClientInput');
    const sapUserInput = document.getElementById('sapUserInput');
    const sapPassInput = document.getElementById('sapPassInput');
    const useSapRouter = document.getElementById('useSapRouter');
    const loginStatus = document.getElementById('loginStatus');
    const loggedInUserDisplays = document.querySelectorAll('#loggedInUserDisplay, #loggedInUserDisplaySub, #loggedInUserDisplayIngreso');
    const headerDataSection = document.getElementById('headerDataSection');
    const clMovimientoInput = document.getElementById('clMovimiento');
    const almacenInput = document.getElementById('almacen');
    const centroInput = document.getElementById('centro');
    const fechaContabInput = document.getElementById('fechaContab');
    const specialStockIndicatorInput = document.getElementById('specialStockIndicator');
    const textoCabeceraInput = document.getElementById('textoCabecera');
    const reservaCheckboxContainer = document.getElementById('reservaCheckboxContainer');
    const reservaCheckbox = document.getElementById('reservaCheckbox');
    const qrContentElement = document.getElementById("qr-content");
    const scanStatusElement = document.getElementById("scan-status");
    const resetButton = document.getElementById("reset-button");
    const saveButton = document.getElementById("save-button");
    const layoutButtonMseg = document.getElementById('layoutButtonMseg');
    const msegTableBody = document.getElementById("msegTableBody");
    const readerMessageElement = document.querySelector('#reader .qr-message');
    const headerInputs = [clMovimientoInput, almacenInput, centroInput, fechaContabInput, specialStockIndicatorInput];
    const startScanButton = document.getElementById('startScanButton');
    const stopScanButton = document.getElementById('stopScanButton');
    const sublocationReader = document.getElementById('sublocationReader');
    const sublocationScanStatus = document.getElementById('sublocationScanStatus');
    const sublocationTableHead = document.getElementById('sublocationTableHead');
    const sublocationTableBody = document.getElementById('sublocationTableBody');
    const sublocationCentroInput = document.getElementById('sublocationCentro');
    const sublocationAlmacenInput = document.getElementById('sublocationAlmacen');
    const sublocationAreaContainer = document.getElementById('sublocationAreaContainer');
    const sublocationReaderMessage = document.querySelector('#sublocationReader .qr-message');
    const sublocationQrContent = document.getElementById('sublocationQrContent');
    const filterInput = document.getElementById('filterInput');
    const exportToExcelButton = document.getElementById('exportToExcelButton');
    const startSublocationScanButton = document.getElementById('startSublocationScanButton');
    const stopSublocationScanButton = document.getElementById('stopSublocationScanButton');
    const layoutButtonSub = document.getElementById('layoutButtonSub');
    const signatureModalElement = document.getElementById('signatureModal');
    const signatureModal = new bootstrap.Modal(signatureModalElement);
    const receptorSelect = document.getElementById('receptorSelect');
    const despachadorSelect = document.getElementById('despachadorSelect');
    const labelSizeSelect = document.getElementById('labelSizeSelect');
    const labelSizeContainer = document.getElementById('labelSizeContainer');
    const confirmSaveButton = document.getElementById('confirmSaveButton');
    const modalErrorMessage = document.getElementById('modal-error-message');
    const searchHelpModalElement = document.getElementById('searchHelpModal');
    const searchHelpModal = new bootstrap.Modal(searchHelpModalElement);
    const searchHelpModalLabel = document.getElementById('searchHelpModalLabel');
    const searchHelpFilter = document.getElementById('searchHelpFilter');
    const searchHelpTableHead = document.getElementById('searchHelpTableHead');
    const searchHelpTableBody = document.getElementById('searchHelpTableBody');
    const layoutModalElement = document.getElementById('layoutModal');
    const layoutModal = new bootstrap.Modal(layoutModalElement);
    const layoutModalBody = document.getElementById('layoutModalBody');
    const applyLayoutButton = document.getElementById('applyLayoutButton');
    const ingresoNroPedidoInput = document.getElementById('ingresoNroPedido');
    const ingresoItemsTableBody = document.getElementById('ingresoItemsTableBody');
    const ingresoSaveButton = document.getElementById('ingresoSaveButton');
    const ingresoClearButton = document.getElementById('ingresoClearButton');
    const ingresoStatus = document.getElementById('ingresoStatus');
    const selectAllIngresoItemsCheckbox = document.getElementById('selectAllIngresoItemsCheckbox');
    const printLabelsButton = document.getElementById('printLabelsButton');
    const printDocMaterialButton = document.getElementById('printDocMaterialButton');
    const longTextModal = new bootstrap.Modal(document.getElementById('longTextModal'));

    // --- FUNCIONES DEL SPINNER ---
    function showSpinner() { spinner.style.display = 'flex'; }
    function hideSpinner() { spinner.style.display = 'none'; }
    function playSound(type) {
        try {
            if (type === 'beep') beepSound.play();
            else if (type === 'error') errorSound.play();
        } catch(e) { console.error("Error playing sound:", e); }
    }

    // --- REGISTRO DE EVENTOS ---
    loginButton.addEventListener('click', () => handleLogin(false));
    guestLoginButton.addEventListener('click', () => handleLogin(true));
    logoutButtons.forEach(btn => btn.addEventListener('click', handleLogout));
    continueButton.addEventListener('click', handleModeSelection);
    backButtons.forEach(btn => btn.addEventListener('click', goBackToModeSelection));
    headerInputs.forEach(input => input.addEventListener('input', handleHeaderChange));
    reservaCheckbox.addEventListener('change', toggleReservaColumn);
    resetButton.addEventListener('click', resetAll);
    saveButton.addEventListener('click', openSignatureModal);
    confirmSaveButton.addEventListener('click', handleConfirmSave);
    [sublocationCentroInput, sublocationAlmacenInput].forEach(input => input.addEventListener('input', manageSublocationScannerState));
    sublocationCentroInput.addEventListener('input', () => {
        if (sublocationCentroInput.value.trim() === '4000') {
            sublocationAreaContainer.style.display = 'block';
        } else {
            sublocationAreaContainer.style.display = 'none';
        }
    });

    almacenInput.addEventListener('input', (e) => {
    e.target.value = e.target.value.toUpperCase();
});
    sublocationTableHead.addEventListener('click', handleSort);
    filterInput.addEventListener('input', filterAndRender);
    exportToExcelButton.addEventListener('click', exportToExcel);
    layoutButtonSub.addEventListener('click', () => openLayoutModal('sublocationTable', sublocationColumnVisibility, 'layoutModalTitle'));
    layoutButtonMseg.addEventListener('click', () => openLayoutModal('msegTable', msegColumnVisibility, 'layoutModalTitle'));
    applyLayoutButton.addEventListener('click', applyLayoutChanges);
    document.getElementById('searchCentro').addEventListener('click', () => openSearchHelp('centro', 'Z_SEARCH_HELP_WERKS', {}, 'searchHelpForPlant'));
    document.getElementById('searchAlmacen').addEventListener('click', () => openSearchHelp('almacen', 'Z_SEARCH_HELP_LGORT', { IV_WERKS: centroInput.value.trim() }, 'searchHelpForStorage'));
    document.getElementById('searchSublocationCentro').addEventListener('click', () => openSearchHelp('sublocationCentro', 'Z_SEARCH_HELP_WERKS', {}, 'searchHelpForPlant'));
    document.getElementById('searchSublocationAlmacen').addEventListener('click', () => openSearchHelp('sublocationAlmacen', 'Z_SEARCH_HELP_LGORT', { IV_WERKS: sublocationCentroInput.value.trim() }, 'searchHelpForStorage'));
    document.getElementById('searchClMovimiento').addEventListener('click', () => openSearchHelp('clMovimiento', 'local_cl_movimiento', {}, 'searchHelpForMoveType'));
    document.getElementById('searchSpecialStock').addEventListener('click', () => openSearchHelp('specialStockIndicator', 'local_stock_especial', {}, 'searchHelpForSpecialStock'));
    searchHelpTableBody.addEventListener('click', handleSearchHelpSelection);
    searchHelpFilter.addEventListener('input', filterSearchHelp);
    startScanButton.addEventListener('click', startScanner);
    stopScanButton.addEventListener('click', stopScanner);
    startSublocationScanButton.addEventListener('click', startSublocationScanner);
    stopSublocationScanButton.addEventListener('click', stopSublocationScanner);
    msegTableBody.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('select-file-btn')) {
            const fileInput = e.target.nextElementSibling;
            if (fileInput && fileInput.classList.contains('file-input')) {
                fileInput.click();
            }
        }
    });
    msegTableBody.addEventListener('change', function(e) {
        if (e.target && e.target.classList.contains('file-input')) {
            const fileInput = e.target;
            const file = fileInput.files[0];
            if (file) {
                const key = fileInput.dataset.key;
                const field = fileInput.dataset.field;
                const displayNameInput = fileInput.parentElement.querySelector('.filename-display');
                if (scannedCodes.has(key)) {
                    const sapData = scannedCodes.get(key);
                    sapData[field] = file;
                    sapData[`${field}_FILENAME`] = file.name;
                    scannedCodes.set(key, sapData);
                }
                if (displayNameInput) {
                    displayNameInput.value = file.name;
                }
            }
        }
    });
    msegTableBody.addEventListener('input', (e) => {
        if (e.target.tagName === 'INPUT' && e.target.type === 'text') {
            const key = e.target.dataset.key;
            const field = e.target.dataset.field;
            const value = e.target.value;
            if (key && field && scannedCodes.has(key)) {
                const data = scannedCodes.get(key);
                data[field] = value;
                scannedCodes.set(key, data);
            }
        }
    });

msegTableBody.addEventListener('click', (e) => {
    const searchButton = e.target.closest('.search-btn');
    if (!searchButton) return;

    // Obtenemos el tipo de búsqueda y la fila actual
    const searchType = searchButton.dataset.searchType;
    const currentRow = searchButton.closest('tr');
    
    if (searchType === 'sublocation_qr') {
        // Obtenemos el campo de texto de la sub-ubicación en esta fila
        const targetInput = currentRow.querySelector('input[data-field="SUB_LOC"]');
        
        // Obtenemos el centro y almacén de los campos de cabecera de la pantalla QR
        const planta = centroInput.value.trim();
        const almacen = almacenInput.value.trim();

        if (!planta || !almacen) {
            alert('Se requiere Planta y Almacén en los datos de cabecera para buscar la sub-ubicación.');
            return;
        }

        // Reutilizamos la misma configuración y llamada que en el otro modo
        const config = {
            display: {'ZZ_SUB_UBIC': 'Sub Ubicacion', 'DESCRIPCION': 'Descripcion'},
            order: ['ZZ_SUB_UBIC', 'DESCRIPCION'],
            returnColumn: 'ZZ_SUB_UBIC'
        };
        
        openSearchHelpForRow(targetInput, 'Z_SEARCH_HELP_SUBLOCATION', { IV_WERKS: planta, IV_LGORT: almacen }, 'Ayuda de Búsqueda - Sub Ubicaciones', config);
    }
});

    document.getElementById('searchPoButton').addEventListener('click', fetchPurchaseOrderItems);
    ingresoClearButton.addEventListener('click', () => clearIngresoForm(true));
    ingresoSaveButton.addEventListener('click', openIngresoSignatureModal);
  //document.querySelectorAll('input[name="ingresoStockEspecial"]').forEach(radio => radio.addEventListener('change', updateIngresoTableVisibility));
    ingresoItemsTableBody.addEventListener('change', e => {
        if (e.target.classList.contains('item-checkbox')) {
            const checkedCount = ingresoItemsTableBody.querySelectorAll('.item-checkbox:checked').length;
            ingresoSaveButton.disabled = checkedCount === 0;
            const totalCheckboxes = ingresoItemsTableBody.querySelectorAll('.item-checkbox').length;
            selectAllIngresoItemsCheckbox.checked = totalCheckboxes > 0 && totalCheckboxes === checkedCount;
        }
    });
    selectAllIngresoItemsCheckbox.addEventListener('change', e => {
        const isChecked = e.target.checked;
        ingresoItemsTableBody.querySelectorAll('.item-checkbox').forEach(checkbox => checkbox.checked = isChecked);
        ingresoSaveButton.disabled = !isChecked || ingresoItemsTableBody.querySelectorAll('.item-checkbox').length === 0;
    });
    ingresoItemsTableBody.addEventListener('click', (e) => {
        const searchButton = e.target.closest('.search-btn');
        if (!searchButton) return;
        const searchType = searchButton.dataset.searchType;
        const currentRow = searchButton.closest('tr');
        const pos = currentRow.dataset.pos;
        const originalItem = poItemsData.find(d => d.EBELP === pos);
        if (searchType === 'lote') {
            const material = originalItem.MATNR;
            const planta = originalItem.WERKS;
            const targetInput = currentRow.querySelector('input[name="lote"]');
            if (!material || !planta) {
                alert('Se requiere Material y Planta en la posición para buscar el lote.');
                return;
            }
            openSearchHelpForRow(targetInput, 'Z_SEARCH_HELP_BATCH', { IV_MATNR: material, IV_WERKS: planta }, 'Ayuda de Búsqueda - Lotes');
        } 
        else if (searchType === 'sublocation') {
            const planta = originalItem.WERKS;
            const almacen = currentRow.querySelector('input[name="almacen"]').value;
            const targetInput = currentRow.querySelector('input[name="sublocation"]');
            if (!planta || !almacen) {
                alert('Se requiere Planta y Almacén para buscar la sub-ubicación.');
                return;
            }
            const config = {
                display: {'ZZ_SUB_UBIC': 'Sub Ubicacion', 'DESCRIPCION': 'Descripcion'},
                order: ['ZZ_SUB_UBIC', 'DESCRIPCION'],
                returnColumn: 'ZZ_SUB_UBIC'
            };
            openSearchHelpForRow(targetInput, 'Z_SEARCH_HELP_SUBLOCATION', { IV_WERKS: planta, IV_LGORT: almacen }, 'Ayuda de Búsqueda - Sub Ubicaciones', config);
        }
        else if (searchType === 'almacen') {
            const planta = originalItem.WERKS;
            const targetInput = currentRow.querySelector('input[name="almacen"]');
            if (!planta) {
                alert('Se requiere la Planta para buscar el almacén.');
                return;
            }
            openSearchHelpForRow(targetInput, 'Z_SEARCH_HELP_LGORT', { IV_WERKS: planta }, 'Ayuda de Búsqueda - Almacén');
        }
        else if (searchType === 'tag') {
            const planta = originalItem.WERKS;
            const targetInput = currentRow.querySelector('input[name="tag"]');
            if (!planta) {
                alert('Se requiere la Planta para buscar el TAG.');
                return;
            }
            const config = {
                display: {'ZZUBICACION': 'TAG', 'DESCRIPCION': 'Descripcion'},
                order: ['ZZUBICACION', 'DESCRIPCION'],
                returnColumn: 'ZZUBICACION'
            };
            openSearchHelpForRow(targetInput, 'Z_SEARCH_HELP_TAG', { IV_WERKS: planta }, 'Ayuda de Búsqueda - TAG', config);
        }
        else if (searchType === 'pais') {
            const targetInput = currentRow.querySelector('input[name="pais"]');
            const config = {
                display: {'ZZ_PAIS': 'Pais', 'DESCRIPCION': 'Descripcion'},
                order: ['ZZ_PAIS', 'DESCRIPCION'],
                returnColumn: 'ZZ_PAIS'
            };
            openSearchHelpForRow(targetInput, 'Z_SEARCH_HELP_COUNTRY', {}, 'Ayuda de Búsqueda - País', config);
        }
    });

        clMovimientoInput.addEventListener('input', () => {
        // Si ya hay códigos escaneados en la tabla...
        if (scannedCodes.size > 0) {
            // ...vuelve a dibujar la tabla para aplicar el cambio.
            renderTable();
        }
    });

       // CONVIERTE A MAYÚSCULAS EL CAMPO LOTE EN TIEMPO REAL
    ingresoItemsTableBody.addEventListener('input', (e) => {
        // Se asegura de que el cambio solo aplique a los campos con el nombre 'lote'
        if (e.target && e.target.getAttribute('name') === 'lote' || e.target.getAttribute('name') === 'almacen') {
            e.target.value = e.target.value.toUpperCase();
        }
    });

    printLabelsButton.addEventListener('click', handlePrintLabels);
    printDocMaterialButton.addEventListener('click', handlePrintDocMaterial);
    ingresoItemsTableBody.addEventListener('dblclick', (e) => {
        const descCell = e.target.closest('.material-description-cell');
        if (!descCell) return;
        const currentRow = descCell.closest('tr');
        const pos = currentRow.dataset.pos;
        const originalItem = poItemsData.find(d => d.EBELP === pos);
        const poNumber = ingresoNroPedidoInput.value;
        if (originalItem && originalItem.MATNR) {
        fetchAndShowLongText(originalItem.MATNR);
    }
    });

    msegTableBody.addEventListener('dblclick', (e) => {
    // Busca la celda de descripción del material a la que se le hizo clic
    const descCell = e.target.closest('.cell-materialDescCol');
    if (!descCell) return; // Si no se hizo clic en la celda correcta, no hace nada

    // Encuentra la fila (tr) completa
    const currentRow = descCell.closest('tr');
    const key = currentRow.dataset.key; // Obtiene la clave única de la fila (ej: "doc-año-pos")

    // Si la clave existe, busca los datos en el mapa 'scannedCodes'
    if (key && scannedCodes.has(key)) {
        const sapData = scannedCodes.get(key); // Obtiene el objeto con todos los datos de esa fila
        
        // Si tenemos los datos y el número de material, llamamos a la función existente
        if (sapData && sapData.MATNR) {
            fetchAndShowLongText(sapData.MATNR);
        }
    }
});

    // --- LÓGICA DE AYUDA DE BÚSQUEDA (MATCHCODE) ---
    async function openSearchHelp(targetInputId, rfcName, params, titleKey, columnConfig = null) {
        currentSearchHelpTarget = document.getElementById(targetInputId);
        searchHelpModalLabel.textContent = getText(titleKey, `${getText('searchHelpTitle')} - ${targetInputId}`);
        searchHelpTableHead.innerHTML = '';
        searchHelpTableBody.innerHTML = `<tr><td colspan="2">${getText('loading')}</td></tr>`;
        searchHelpFilter.value = '';
        searchHelpModal.show();
        if (rfcName.startsWith('local_')) {
            let localData = [];
            if (rfcName === 'local_cl_movimiento') {
                localData = [{ 'CL_MOV': '101' }, { 'CL_MOV': '221' }, { 'CL_MOV': '231' }, { 'CL_MOV': '601' },  { 'CL_MOV': '311' }];
            } else if (rfcName === 'local_stock_especial') {
                localData = [{ 'STOCK_ESP': '' }, { 'STOCK_ESP': 'Q' }, { 'STOCK_ESP': 'E' }];
            }
            populateSearchHelpTable(localData, columnConfig);
            return;
        }
        showSpinner();
        try {
            const response = await fetch(`${API_BASE_URL}/getSearchHelpData`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    connection_params: sapConnection,
                    rfc_name: rfcName,
                    rfc_params: params,
                    is_guest: isGuestMode
                })
            });
            const result = await response.json();
            if (result.success) {
                populateSearchHelpTable(result.data, columnConfig);
            } else {
                searchHelpTableBody.innerHTML = `<tr><td colspan="2" class="text-danger">${result.error}</td></tr>`;
            }
        } catch (e) {
            searchHelpTableBody.innerHTML = `<tr><td colspan="2" class="text-danger">${getText('networkError')}: ${e.message}</td></tr>`;
        } finally {
            hideSpinner();
        }
    }
    
    async function openSearchHelpForRow(targetInput, rfcName, params, title, columnConfig = null) {
        currentSearchHelpTargetRowInput = targetInput;
        searchHelpModalLabel.textContent = title;
        searchHelpTableHead.innerHTML = '';
        searchHelpTableBody.innerHTML = `<tr><td colspan="2">${getText('loading')}</td></tr>`;
        searchHelpFilter.value = '';
        searchHelpModal.show();
        showSpinner();
        try {
            const response = await fetch(`${API_BASE_URL}/getSearchHelpData`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    connection_params: sapConnection,
                    rfc_name: rfcName,
                    rfc_params: params,
                    is_guest: isGuestMode
                })
            });
            const result = await response.json();
            if (result.success) {
                populateSearchHelpTable(result.data, columnConfig);
            } else {
                searchHelpTableBody.innerHTML = `<tr><td colspan="2" class="text-danger">${result.error}</td></tr>`;
            }
        } catch (e) {
            searchHelpTableBody.innerHTML = `<tr><td colspan="2" class="text-danger">${getText('networkError')}: ${e.message}</td></tr>`;
        } finally {
            hideSpinner();
        }
    }

    function populateSearchHelpTable(data, columnConfig = null) {
        if (!data || data.length === 0) {
            searchHelpTableBody.innerHTML = `<tr><td colspan="2">${getText('noDataFound')}</td></tr>`;
            return;
        }
        if (columnConfig) {
            const columnDisplayNames = columnConfig.display;
            const columnOrder = columnConfig.order;
            const returnColumn = columnConfig.returnColumn;
            searchHelpTableHead.innerHTML = `<tr>${columnOrder.map(key => `<th>${columnDisplayNames[key]}</th>`).join('')}</tr>`;
            searchHelpTableBody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.style.cursor = 'pointer';
                tr.dataset.returnValue = row[returnColumn];
                let rowHtml = '';
                columnOrder.forEach(key => {
                    rowHtml += `<td>${row[key] || ''}</td>`;
                });
                tr.innerHTML = rowHtml;
                searchHelpTableBody.appendChild(tr);
            });
        } else {
            const headerTranslations = {
                'WERKS': 'plantCol', 'NAME1': 'plantNameCol', 'LGORT': 'storageCol', 'LGOBE': 'storageNameCol',
                'CL_MOV': 'moveTypeCol', 'STOCK_ESP': 'specialStockCol'
            };
            const allHeaders = Object.keys(data[0]);
            const codeFields = ['WERKS', 'LGORT', 'CL_MOV', 'STOCK_ESP'];
            const descFields = ['NAME1', 'LGOBE'];
            let orderedHeaders = [];
            let codeHeader = allHeaders.find(h => codeFields.includes(h));
            let descHeader = allHeaders.find(h => descFields.includes(h));
            if (codeHeader) orderedHeaders.push(codeHeader);
            if (descHeader) orderedHeaders.push(descHeader);
            allHeaders.forEach(h => {
                if (!orderedHeaders.includes(h)) {
                    orderedHeaders.push(h);
                }
            });
            searchHelpTableHead.innerHTML = `<tr>${orderedHeaders.map(h => `<th>${getText(headerTranslations[h], h)}</th>`).join('')}</tr>`;
            searchHelpTableBody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.style.cursor = 'pointer';
                const returnValue = row[orderedHeaders[0]];
                tr.dataset.returnValue = returnValue;
                tr.innerHTML = orderedHeaders.map(h => `<td>${row[h]}</td>`).join('');
                searchHelpTableBody.appendChild(tr);
            });
        }
    }

    function handleSearchHelpSelection(e) {
        const row = e.target.closest('tr');
        if (!row || row.dataset.returnValue === undefined) return;
        const value = row.dataset.returnValue;
        if (currentSearchHelpTargetRowInput) {
            currentSearchHelpTargetRowInput.value = value;
            currentSearchHelpTargetRowInput.dispatchEvent(new Event('input'));
            currentSearchHelpTargetRowInput = null;
        } 
        else if (currentSearchHelpTarget) {
            currentSearchHelpTarget.value = value;
            currentSearchHelpTarget.dispatchEvent(new Event('input'));
        }
        searchHelpModal.hide();
    }

    function filterSearchHelp() {
        const filterText = searchHelpFilter.value.toLowerCase();
        const rows = searchHelpTableBody.getElementsByTagName('tr');
        for (const row of rows) {
            const cells = row.getElementsByTagName('td');
            let found = false;
            for (const cell of cells) {
                if (cell.textContent.toLowerCase().includes(filterText)) {
                    found = true;
                    break;
                }
            }
            row.style.display = found ? '' : 'none';
        }
    }

    async function handleLogin(isGuest) {
        isGuestMode = isGuest;
        setLoginStatus(getText('validating'), "info");
        showSpinner();
        sapConnection = null;
        const selectedOption = sapEnvSelect.options[sapEnvSelect.selectedIndex];
        const connectionParamsForThisAttempt = {
            ashost: selectedOption.dataset.host,
            sysnr: selectedOption.dataset.sysnr,
            client: sapClientInput.value.trim(),
        };
        if (useSapRouter.checked) {
            connectionParamsForThisAttempt.saprouter = SAP_ROUTER_STRING;
        }
        if (!isGuest) {
            connectionParamsForThisAttempt.user = sapUserInput.value.trim();
            connectionParamsForThisAttempt.passwd = sapPassInput.value.trim();
        }
        const endpoint = isGuest ? `${API_BASE_URL}/validateGuestLogin` : `${API_BASE_URL}/validateLogin`;
        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ connection_params: connectionParamsForThisAttempt })
            });
            const result = await response.json();
            if (result.success) {
                sapConnection = connectionParamsForThisAttempt;
                const userToShow = isGuest ? (result.guest_user || 'Invitado') : connectionParamsForThisAttempt.user;
                loginSection.style.display = 'none';
                modeSelectionSection.style.display = 'block';
                const displayText = `${getText('user')}: ${userToShow.toUpperCase()} (${sapEnvSelect.value})`;
                loggedInUserDisplays.forEach(display => {
                    display.textContent = displayText;
                });
            } else {
                sapConnection = null;
                setLoginStatus(`Error: ${result.error}`, 'error');
                playSound('error');
            }
        } catch (e) {
            sapConnection = null;
            setLoginStatus(`${getText('networkError')}: ${e.message}`, 'error');
            playSound('error');
        } finally {
            hideSpinner();
        }
    }

    async function handleLogout() {
        await stopAllScanners();
        sapConnection = null;
        isGuestMode = false;
        mainContent.style.display = 'none';
        sublocationContent.style.display = 'none';
        ingresoContent.style.display = 'none';
        modeSelectionSection.style.display = 'none';
        loginSection.style.display = 'block';
        sapPassInput.value = '';
        setLoginStatus(getText('sessionClosed'), "info");
        clearAllScreens();
    }

    function handleModeSelection() {
        const selectedMode = document.querySelector('input[name="appMode"]:checked').value;
        modeSelectionSection.style.display = 'none';
        mainContent.style.display = 'none';
        sublocationContent.style.display = 'none';
        ingresoContent.style.display = 'none';
        if (selectedMode === 'etiqueta') {
            mainContent.style.display = 'block';
            if (isGuestMode) {
                headerDataSection.style.display = 'none';
            } else {
                headerDataSection.style.display = 'block';
                fechaContabInput.valueAsDate = new Date();
            }
            handleHeaderChange();
        } else if (selectedMode === 'sublocation') {
            sublocationContent.style.display = 'block';
            manageSublocationScannerState();
        } else if (selectedMode === 'ingreso') {
            ingresoContent.style.display = 'block';
            document.getElementById('ingresoFechaDoc').valueAsDate = new Date();
            document.getElementById('ingresoFechaCont').valueAsDate = new Date();
            updateIngresoTableVisibility();
        }
    }

    async function goBackToModeSelection() {
        await stopAllScanners();
        mainContent.style.display = 'none';
        sublocationContent.style.display = 'none';
        ingresoContent.style.display = 'none';
        modeSelectionSection.style.display = 'block';
        clearAllScreens();
    }

    function setLoginStatus(message, type) {
        loginStatus.textContent = message;
        loginStatus.className = `mt-3 text-center message-${type}`;
    }

    async function stopAllScanners() {
        if (html5QrCode && html5QrCode.isScanning) {
            try { await html5QrCode.stop(); } catch(e) { console.error("Error stopping main scanner:", e); }
        }
        if (html5QrCodeSublocation && html5QrCodeSublocation.isScanning) {
            try { await html5QrCodeSublocation.stop(); } catch(e) { console.error("Error stopping sublocation scanner:", e); }
        }
        isScanning = false;
        isSublocationScanning = false;
        if (document.getElementById('reader')) {
            document.getElementById('reader').style.display = 'none';
            startScanButton.style.display = 'block';
        }
        setScanStatus(getText('scannerStopped'), "info");
        if (sublocationReader) {
            sublocationReader.style.display = 'none';
            startSublocationScanButton.style.display = 'block';
            sublocationScanStatus.textContent = '';
        }
    }

    function handleHeaderChange() {
        if (!isGuestMode) { toggleReservaCheckbox(); }
        manageScannerState();
        toggleSpecialColumnsVisibility();
    }
    function areHeadersFilled() {
        if (isGuestMode) { return true; }
        return clMovimientoInput.value.trim() && almacenInput.value.trim() && centroInput.value.trim() && fechaContabInput.value;
    }
    async function manageScannerState() {
        if (areHeadersFilled()) {
            startScanButton.disabled = false;
            readerMessageElement.textContent = '';
            readerMessageElement.style.display = 'none';
        } else {
            startScanButton.disabled = true;
            if (isScanning) await stopScanner();
            readerMessageElement.textContent = getText('completeFiltersToScan');
            readerMessageElement.style.display = 'block';
        }
    }
    async function startScanner() {
        if (isScanning) return;
        isScanning = true;
        readerMessageElement.style.display = 'none';
        document.getElementById('reader').style.display = 'block';
        startScanButton.style.display = 'none';
        stopScanButton.style.display = 'inline-block'; 
        html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        try {
            await html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, (errorMessage) => {});
            setScanStatus(getText('readyToScan'), "success");
        } catch (err) {
            setScanStatus(`${getText('cameraError')}: ${err}`, "error");
            isScanning = false;
            document.getElementById('reader').style.display = 'none';
            startScanButton.style.display = 'block';
             stopScanButton.style.display = 'none';
        }
    }
    async function stopScanner() {
        if (!isScanning || !html5QrCode) return;
        try {
            await html5QrCode.stop();
        } catch(err) { /* Ignorar error */ }
        isScanning = false;
        document.getElementById('reader').style.display = 'none';
        startScanButton.style.display = 'block';
        stopScanButton.style.display = 'none'; 
        setScanStatus(getText('scannerStopped'), "info");
    }
    async function onScanSuccess(decodedText) {
        await stopScanner();
        let rfc_params;
        try {
            if (decodedText.length === 18 && /^\d+$/.test(decodedText)) {
                rfc_params = { documentNumber: decodedText.substring(0, 10), documentYear: decodedText.substring(10, 14), item: decodedText.substring(14, 18) };
            } else {
                rfc_params = JSON.parse(decodedText);
            }
            if (!rfc_params.documentNumber || !rfc_params.documentYear || !rfc_params.item) {
                throw new Error("El QR no contiene los datos necesarios (documento, año, posición).");
            }
        } catch (e) {
            setScanStatus(`${getText('invalidQrFormat')} ${e.message}`, "error");
            playSound('error');
            return;
        }

        const key = `${rfc_params.documentNumber}-${rfc_params.documentYear}-${rfc_params.item}`;
        if (scannedCodes.has(key)) {
            setScanStatus(getText('codeAlreadyScanned'), "error");
            playSound('error');
            return;
        }
        qrContentElement.textContent = decodedText;
        setScanStatus(getText('processing'), "info");
        await fetchMsegData(rfc_params);
    }
    async function fetchMsegData(rfc_params) {
        if (!sapConnection) {
            setScanStatus(getText('sessionError'), "error");
            playSound('error');
            return;
        }
        showSpinner();
        const payload = {
            connection_params: sapConnection,
            rfc_params: { ...rfc_params, moveType: clMovimientoInput.value, specialStockIndicator: specialStockIndicatorInput.value },
            is_guest: isGuestMode,
            centro: centroInput.value.trim()
        };
        try {
            const response = await fetch(`${API_BASE_URL}/getMsegData`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
            const result = await response.json();
            if (result.success) {
                setScanStatus(getText('validationSuccess'), "success");
                playSound('beep');
                const key = `${rfc_params.documentNumber}-${rfc_params.documentYear}-${rfc_params.item}`;
                scannedCodes.set(key, result.msegData);
                renderTable();
            } else {
                setScanStatus(result.error || "Error.", "error");
                playSound('error');
            }
        } catch (e) {
            setScanStatus(`${getText('networkError')}: ${e.message}`, "error");
            playSound('error');
        } finally {
            hideSpinner();
        }
    }
    function toggleReservaCheckbox() {
        const clMov = clMovimientoInput.value.trim();
        const stock = specialStockIndicatorInput.value.trim().toUpperCase();
        const showCheckbox = clMov === '221' && stock === 'Q';
        reservaCheckboxContainer.classList.toggle('visible', showCheckbox);
        if (!showCheckbox) {
            reservaCheckbox.checked = false;
        }
        toggleReservaColumn();
    }
    function toggleReservaColumn() {
        const shouldBeVisible = reservaCheckbox.checked;
        msegColumnVisibility['reservationCol'] = shouldBeVisible;
        updateTableVisibility('msegTable', msegColumnVisibility);
    }
    function renderTable() {
msegTableBody.innerHTML = '';
    
    const currentMoveType = clMovimientoInput.value.trim();

    scannedCodes.forEach((sapData, key) => {
        const [doc, year, item] = key.split('-');
        const tr = document.createElement("tr");
        tr.dataset.key = key; // <-- Añadimos el key a la fila para encontrarlo fácilmente
        const isReadOnly = isGuestMode ? 'readonly' : '';
        const materialDisplay = (sapData.MATNR || '').replace(/^0+/, '');

        // Lógica para decidir si la celda es editable y tiene matchcode
        let sublocationCellHtml = '';
        if (currentMoveType === '101') {
            // Si es 101, creamos un campo de texto con su botón de búsqueda
            sublocationCellHtml = `
                <td class="cell-subLocCol">
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control form-control-sm" value="${sapData.SUB_LOC || ''}" data-key="${key}" data-field="SUB_LOC">
                        <button class="btn btn-outline-secondary search-btn" type="button" data-search-type="sublocation_qr"><i class="bi bi-search"></i></button>
                    </div>
                </td>`;
        } else {
            // Para cualquier otro movimiento, creamos una celda <td> normal
            sublocationCellHtml = `<td class="cell-subLocCol">${sapData.SUB_LOC || ''}</td>`;
        }

        // Construimos la fila completa
        tr.innerHTML = `
            <td class="cell-docCol">${doc}</td>
            <td class="cell-yearCol">${year}</td>
            <td class="cell-posCol">${item}</td>
            <td class="cell-materialCol">${materialDisplay}</td>
            <td class="cell-materialDescCol" style="cursor: pointer;">${sapData.MAKTX || ''}</td>
            <td class="cell-qtyCol"><input type="text" class="form-control form-control-sm" value="${sapData.MENGE || '0'}" data-key="${key}" data-field="MENGE" ${isReadOnly}></td>
            <td class="cell-unitCol">${sapData.MEINS || ''}</td>
            <td class="cell-batchCol">${sapData.CHARG || ''}</td>
            <td class="cell-certCol">
                <div class="input-group input-group-sm">
                    <input type="text" class="form-control filename-display" value="${sapData.CERTIFICADO_FILENAME || ''}" readonly>
                    <button class="btn btn-outline-secondary select-file-btn" type="button" ${isReadOnly}>...</button>
                    <input type="file" class="file-input" data-key="${key}" data-field="CERTIFICADO" style="display: none;">
                </div>
            </td>
            <td class="cell-docsCol">
                <div class="input-group input-group-sm">
                    <input type="text" class="form-control filename-display" value="${sapData.DOCUMENTO_FILENAME || ''}" readonly>
                    <button class="btn btn-outline-secondary select-file-btn" type="button" ${isReadOnly}>...</button>
                    <input type="file" class="file-input" data-key="${key}" data-field="DOCUMENTO" style="display: none;">
                </div>
            </td>
            <td class="cell-inspCol">
                <div class="input-group input-group-sm">
                    <input type="text" class="form-control filename-display" value="${sapData.INSPECCION_FILENAME || ''}" readonly>
                    <button class="btn btn-outline-secondary select-file-btn" type="button" ${isReadOnly}>...</button>
                    <input type="file" class="file-input" data-key="${key}" data-field="INSPECCION" style="display: none;">
                </div>
            </td>
            <td class="cell-itemTextCol"><input type="text" class="form-control form-control-sm" value="${sapData.SGTXT || ''}" data-key="${key}" data-field="SGTXT" ${isReadOnly}></td>
            <td class="cell-tagCol">${sapData.TAG || ''}</td>
            ${sublocationCellHtml}
            <td class="cell-areaCol">${sapData.SUBMI || ''}</td>
            <td class="cell-orderNoCol">${sapData.EBELN || ''}</td>
            <td class="cell-orderNo2Col d-none">${sapData.EBELN2 || ''}</td>
            <td class="cell-wbsCol">${sapData.PS_PSP_PNR || ''}</td>
            <td class="cell-reservationCol reserva-cell d-none"><input type="text" class="form-control form-control-sm" value="${sapData.RSNUM || ''}" data-key="${key}" data-field="RSNUM" ${isReadOnly}></td>
            <td class="cell-salesOrderCol">${sapData.KDAUF || ''}</td>
            <td class="cell-salesOrderItemCol">${sapData.KDPOS || ''}</td>
        `;
        msegTableBody.appendChild(tr);
    });
    updateButtonsVisibility();
    updateTableVisibility('msegTable', msegColumnVisibility);
    toggleSpecialColumnsVisibility();
}
async function openSignatureModal() {

const moveType = clMovimientoInput.value.trim();

    // La validación solo se ejecuta si el tipo de movimiento es '101'
    if (moveType === '101') {
        let allSublocationsAreValid = true;
        const sublocationInputs = msegTableBody.querySelectorAll('input[data-field="SUB_LOC"]');

        sublocationInputs.forEach(input => {
            // Primero, removemos cualquier marca de error anterior
            input.classList.remove('is-invalid');

            // Verificamos si el campo está vacío
            if (input.value.trim() === '') {
                input.classList.add('is-invalid'); // Lo marcamos en rojo (estilo de Bootstrap)
                allSublocationsAreValid = false;   // Marcamos que hay un error
            }
        });

        // Si se encontró al menos un campo vacío...
        if (!allSublocationsAreValid) {
            const errorMessage = "El campo Sub-Ubicación es obligatorio. Por favor, complete los campos marcados en rojo.";
            alert(errorMessage); // Mostramos una alerta al usuario
            setScanStatus(errorMessage, "error"); // También lo ponemos en la barra de estado
            playSound('error');
            return; // Detenemos la ejecución para que no se abra la ventana de firmas
        }
    }
    currentSaveHandler = saveData;
    modalErrorMessage.style.display = 'none';
    receptorSelect.innerHTML = `<option value="">${getText('loading')}</option>`;
    despachadorSelect.innerHTML = `<option value="">${getText('loading')}</option>`;
    labelSizeSelect.value = '';

    // --- Lógica condicional para mostrar/ocultar campos ---
    const centro = centroInput.value.trim();

    // Verificamos la condición especial: Movimiento 101 y Centro 4000
    if (moveType === '101' && centro === '4000') {
        // Si se cumple, OCULTAMOS el Despachador y el Tamaño de Etiqueta
        despachadorSelect.parentElement.style.display = 'none';
        labelSizeContainer.style.display = 'none';
    } else {
        // Para cualquier otro caso, restauramos el comportamiento original
        despachadorSelect.parentElement.style.display = 'block';
        
        // Mantenemos la lógica original para el tamaño de la etiqueta
        const hideLabelSizeFor = ['221', '231', '601', '311'];
        labelSizeContainer.style.display = hideLabelSizeFor.includes(moveType) ? 'none' : 'block';
    }

    setScanStatus(getText('loadingData'), "info");
    showSpinner();
    try {
            const response = await fetch(`${API_BASE_URL}/getModalData`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    connection_params: sapConnection,
                    centro: centroInput.value.trim(),
                    is_guest: isGuestMode
                })
            });
            const result = await response.json();
            if (result.success) {
                receptorSelect.innerHTML = `<option value="">${getText('selectSize')}</option>`;
                result.receptores.forEach(r => {
                    const option = new Option(r.RECEPTOR, r.RECEPTOR);
                    receptorSelect.add(option);
                });
                if (result.currentUser && result.currentUser.fullName) {
                    const userFullName = result.currentUser.fullName;
                    const userExistsInList = result.receptores.some(r => r.RECEPTOR === userFullName);
                    if (userExistsInList) {
                        receptorSelect.value = userFullName;
                    } else {
                        const option = new Option(userFullName, userFullName);
                        receptorSelect.add(option);
                        receptorSelect.value = userFullName;
                    }
                }
                despachadorSelect.innerHTML = `<option value="">${getText('selectDispatcher')}</option>`;
                result.despachadores.forEach(d => {
                    const option = new Option(d.RECEPTOR, d.RECEPTOR);
                    despachadorSelect.add(option);
                });
                setScanStatus("", "");
                signatureModal.show();
            } else {
                setScanStatus(`${getText('loadingData')}: ${result.error}`, "error");
                playSound('error');
                alert(`${getText('confirmWindowError')}:\n${result.error}`);
            }
        } catch (e) {
            setScanStatus(`${getText('networkError')}: ${e.message}`, "error");
            playSound('error');
            alert(`${getText('confirmWindowError')}.`);
        } finally {
            hideSpinner();
        }
    }
    async function openIngresoSignatureModal() {

    let allSublocationsAreValid = true;
    const selectedRows = ingresoItemsTableBody.querySelectorAll('.item-checkbox:checked');

    // Revisamos cada una de las filas que el usuario ha seleccionado
    selectedRows.forEach(checkbox => {
        const row = checkbox.closest('tr');
        const sublocationInput = row.querySelector('input[name="sublocation"]');
        
        if (sublocationInput) {
            // Limpiamos cualquier error previo
            sublocationInput.classList.remove('is-invalid');

            // Si el campo de sub-ubicación de esta fila seleccionada está vacío...
            if (sublocationInput.value.trim() === '') {
                sublocationInput.classList.add('is-invalid'); // Lo marcamos en rojo
                allSublocationsAreValid = false; // Anotamos que hay un error
            }
        }
    });

    // Si después de revisar todas las filas seleccionadas se encontró un error...
    if (!allSublocationsAreValid) {
        const errorMessage = "El campo Sub-Ubicación es obligatorio para las posiciones seleccionadas. Por favor, complete los campos marcados en rojo.";
        alert(errorMessage);
        setIngresoStatus(errorMessage, "error");
        playSound('error');
        return; // Detenemos el proceso y no abrimos la ventana de firmas
    }
        const selectedItems = ingresoItemsTableBody.querySelectorAll('.item-checkbox:checked');
        if (selectedItems.length === 0) {
            alert('Debe seleccionar al menos una posición para guardar.');
            return;
        }
        const firstSelectedRow = selectedItems[0].closest('tr');
        const pos = firstSelectedRow.dataset.pos;
        const originalItem = poItemsData.find(d => d.EBELP === pos);
        const centroParaModal = originalItem ? originalItem.WERKS : '';
        if (!centroParaModal) {
             alert('No se pudo determinar el Centro para cargar los datos del modal.');
             return;
        }
        despachadorSelect.parentElement.style.display = 'none';
        labelSizeContainer.style.display = 'block';
        currentSaveHandler = saveIngresoData;
        modalErrorMessage.style.display = 'none';
        receptorSelect.innerHTML = `<option value="">${getText('loading')}</option>`;
        labelSizeSelect.value = '';
        setIngresoStatus(getText('loadingData'), "info");
        showSpinner();
        try {
            const response = await fetch(`${API_BASE_URL}/getModalData`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    connection_params: sapConnection,
                    centro: centroParaModal,
                    is_guest: isGuestMode
                })
            });
            const result = await response.json();
            if (result.success) {
                receptorSelect.innerHTML = `<option value="">Seleccione un receptor...</option>`;
                result.receptores.forEach(r => {
                    const option = new Option(r.RECEPTOR, r.RECEPTOR);
                    receptorSelect.add(option);
                });
            if (result.currentUser && result.currentUser.fullName) {
                const userFullName = result.currentUser.fullName;
                const userExistsInList = result.receptores.some(r => r.RECEPTOR === userFullName);

                if (userExistsInList) {
                    // Si el usuario existe en la lista, lo seleccionamos.
                    receptorSelect.value = userFullName;
                } else {
                    // Si NO existe, lo añadimos a la lista y luego lo seleccionamos.
                    const option = new Option(userFullName, userFullName);
                    receptorSelect.add(option);
                    receptorSelect.value = userFullName;
                }
            }
                setIngresoStatus("", "");
                signatureModal.show();
            } else {
                setIngresoStatus(`${getText('loadingData')}: ${result.error}`, "error");
                playSound('error');
                alert(`${getText('confirmWindowError')}:\n${result.error}`);
            }
        } catch (e) {
            setIngresoStatus(`${getText('networkError')}: ${e.message}`, "error");
            playSound('error');
            alert(`${getText('confirmWindowError')}.`);
        } finally {
            hideSpinner();
        }
    }
    function handleConfirmSave() {
        const isLabelSizeVisible = labelSizeContainer.style.display !== 'none';
        const isDespachadorVisible = despachadorSelect.parentElement.style.display !== 'none';
        const signatureData = {
            receptor: receptorSelect.value,
            despachador: isDespachadorVisible ? despachadorSelect.value : '',
            labelSize: isLabelSizeVisible ? labelSizeSelect.value : ''
        };
        let isValid = true;
        if (!signatureData.receptor) isValid = false;
        if (isDespachadorVisible && !signatureData.despachador) isValid = false;
        if (isLabelSizeVisible && !signatureData.labelSize) isValid = false;
        if (!isValid) {
            modalErrorMessage.textContent = getText('allFieldsRequired');
            modalErrorMessage.style.display = 'block';
            return;
        }
        modalErrorMessage.style.display = 'none';
        signatureModal.hide();
        if (typeof currentSaveHandler === 'function') {
            currentSaveHandler(signatureData);
        } else {
            console.error("Error: No se ha definido un manejador de guardado.");
        }
    }
    async function saveData(signatureData) {
        if (isGuestMode || !sapConnection) { alert("Acción no permitida."); return; }
        setScanStatus(getText('preparingData'), "info");
        showSpinner();
        const formData = new FormData();
        const headerData = {
            clMovimiento: clMovimientoInput.value, almacen: almacenInput.value, centro: centroInput.value,
            textoCabecera: textoCabeceraInput.value, fechaContab: fechaContabInput.value,
            specialStockIndicator: specialStockIndicatorInput.value, isReservaChecked: reservaCheckbox.checked
        };
const itemsForJson = Array.from(scannedCodes.entries()).map(([key, sapData]) => {
    const [documentNumber, documentYear, item] = key.split('-');

    // Buscamos la fila correspondiente en la tabla para leer los datos actuales
    const row = msegTableBody.querySelector(`tr[data-key="${key}"]`);

    let subLocValue = sapData.SUB_LOC; // Valor por defecto

    // Si la fila existe, leemos los valores directamente de los inputs
    if (row) {
        const mengeInput = row.querySelector('input[data-field="MENGE"]');
        const sgtxtInput = row.querySelector('input[data-field="SGTXT"]');
        const subLocInput = row.querySelector('input[data-field="SUB_LOC"]');
        const rsnumInput = row.querySelector('input[data-field="RSNUM"]');

        // Actualizamos los datos del objeto 'sapData' con los valores actuales de la tabla
        // Esto asegura que cualquier cambio se capture
        if (mengeInput) sapData.MENGE = mengeInput.value;
        if (sgtxtInput) sapData.SGTXT = sgtxtInput.value;
        if (subLocInput) sapData.SUB_LOC = subLocInput.value; // <-- Aquí capturamos la sub-ubicación editada
        if (rsnumInput) sapData.RSNUM = rsnumInput.value;
    }

    return {
        documentNumber, documentYear, item,
        MATNR: sapData.MATNR,
        MAKTX: sapData.MAKTX,
        MENGE: sapData.MENGE, // Se usa el valor actualizado
        MEINS: sapData.MEINS,
        CHARG: sapData.CHARG,
        SGTXT: sapData.SGTXT, // Se usa el valor actualizado
        TAG: sapData.TAG, // Corregido para usar 'TAG' que sí existe en el objeto
        SUB_LOC: sapData.SUB_LOC, // Se usa el valor actualizado
        SUBMI: sapData.SUBMI,
        EBELN: sapData.EBELN,
        PS_PSP_PNR: sapData.PS_PSP_PNR,
        KDAUF: sapData.KDAUF,
        KDPOS: sapData.KDPOS,
        RSNUM: sapData.RSNUM // Se usa el valor actualizado
    };
});
        const jsonDataPayload = {
            connection_params: sapConnection,
            header: headerData,
            items: itemsForJson,
            is_guest: isGuestMode,
            signature_data: signatureData
        };
        formData.append('json_data', JSON.stringify(jsonDataPayload));
        const fileMetadata = [];
        scannedCodes.forEach((sapData, key) => {
            ['CERTIFICADO', 'DOCUMENTO', 'INSPECCION'].forEach(field => {
                if (sapData[field] instanceof File) {
                    formData.append('files[]', sapData[field]);
                    fileMetadata.push({ key: key, field: field });
                }
            });
        });
        formData.append('file_metadata', JSON.stringify(fileMetadata));
        setScanStatus(getText('savingData'), "info");
        try {
            const response = await fetch(`${API_BASE_URL}/saveDataToSap`, { method: "POST", body: formData });
            const result = await response.json();
            if (result.success) {
                let finalMessage = `${getText('processCompleted')} Doc: ${result.sap_document_number}`;
                if (result.warning) {
                    finalMessage += `\nAVISO: ${result.warning}`;
                    setScanStatus(finalMessage, "warning");
                } else {
                    setScanStatus(finalMessage, "success");
                }
                playSound('beep');
                alert(finalMessage);
                await resetAll();
            } else {
                setScanStatus(`${getText('saveError')}: ${result.error}`, "error");
                playSound('error');
                alert(`${getText('saveError')}:\n${result.error}`);
            }
        } catch (e) {
            setScanStatus(`${getText('networkError')}: ${e.message}`, "error");
            playSound('error');
        } finally {
            hideSpinner();
        }
    }
    async function resetAll() {
        await stopScanner();
        clearFormAndTable();
        manageScannerState();
        toggleSpecialColumnsVisibility();
    }
    function clearFormAndTable() {
        msegTableBody.innerHTML = '';
        scannedCodes.clear();
        qrContentElement.textContent = '';
        textoCabeceraInput.value = '';
        reservaCheckbox.checked = false;
        setScanStatus("", "");
        updateButtonsVisibility();
        toggleReservaColumn();
    }
    function updateButtonsVisibility() {
        const showButtons = msegTableBody.rows.length > 0;
        resetButton.style.display = showButtons ? 'inline-block' : 'none';
        layoutButtonMseg.style.display = showButtons ? 'inline-block' : 'none';
        const showSave = showButtons && !isGuestMode;
        saveButton.style.display = showSave ? 'inline-block' : 'none';
    }
    function setScanStatus(message, type) {
        scanStatusElement.textContent = message;
        scanStatusElement.className = `lead text-center message-${type}`;
    }
    function initializeColumnVisibility(tableId) {
        const visibilityObject = {};
        document.querySelectorAll(`#${tableId} thead th`).forEach(th => {
            const columnKey = th.dataset.column;
            if (columnKey) {
                visibilityObject[columnKey] = !th.classList.contains('d-none');
            }
        });
        return visibilityObject;
    }
    function openLayoutModal(tableId, visibilityObject, titleKey) {
        currentLayoutConfig = { tableId, visibilityObject };
        layoutModalLabel.textContent = getText(titleKey);
        layoutModalBody.innerHTML = '';
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'd-flex justify-content-end mb-2';
        buttonContainer.innerHTML = `
            <button type="button" class="btn btn-link btn-sm" id="selectAllLayoutBtn">${getText('selectAll')}</button>
            <button type="button" class="btn btn-link btn-sm" id="deselectAllLayoutBtn">${getText('deselectAll')}</button>
        `;
        layoutModalBody.appendChild(buttonContainer);
        const checkboxesContainer = document.createElement('div');
        checkboxesContainer.id = 'layoutCheckboxesContainer';
        layoutModalBody.appendChild(checkboxesContainer);
        const headers = document.querySelectorAll(`#${tableId} thead th`);
        headers.forEach(th => {
            const columnKey = th.dataset.column;
            if (!columnKey) return;
            const labelText = th.dataset.translate ? getText(th.dataset.translate) : th.childNodes[0].nodeValue.trim();
            const isVisible = visibilityObject[columnKey];
            const formCheck = document.createElement('div');
            formCheck.className = 'form-check';
            formCheck.innerHTML = `
                <input class="form-check-input" type="checkbox" value="${columnKey}" id="check-${columnKey}" ${isVisible ? 'checked' : ''}>
                <label class="form-check-label" for="check-${columnKey}">
                    ${labelText}
                </label>
            `;
            checkboxesContainer.appendChild(formCheck);
        });
        document.getElementById('selectAllLayoutBtn').addEventListener('click', () => {
            checkboxesContainer.querySelectorAll('.form-check-input').forEach(chk => chk.checked = true);
        });
        document.getElementById('deselectAllLayoutBtn').addEventListener('click', () => {
            checkboxesContainer.querySelectorAll('.form-check-input').forEach(chk => chk.checked = false);
        });
        layoutModal.show();
    }
    function applyLayoutChanges() {
        const { tableId, visibilityObject } = currentLayoutConfig;
        const checkboxes = layoutModalBody.querySelectorAll('.form-check-input');
        checkboxes.forEach(chk => {
            visibilityObject[chk.value] = chk.checked;
        });
        updateTableVisibility(tableId, visibilityObject);
        layoutModal.hide();
    }

function toggleSpecialColumnsVisibility() {
    const moveType = clMovimientoInput.value.trim();
    const centro = centroInput.value.trim();
    const shouldShow = (moveType === '101' && centro === '4000');

    // Seleccionamos todas las cabeceras y celdas de las columnas que queremos controlar
    const wbsElements = document.querySelectorAll('[data-column="wbsCol"], .cell-wbsCol');
    const orderNo2Elements = document.querySelectorAll('[data-column="orderNo2Col"], .cell-orderNo2Col');

    // Usamos toggle para añadir o quitar la clase 'd-none' según la condición
    wbsElements.forEach(el => el.classList.toggle('d-none', !shouldShow));
    orderNo2Elements.forEach(el => el.classList.toggle('d-none', !shouldShow));
}

 function updateTableVisibility(tableId, visibilityObject) {
    for (const columnKey in visibilityObject) {
        const isVisible = visibilityObject[columnKey]; 
        const cells = document.querySelectorAll(`#${tableId} [data-column="${columnKey}"], #${tableId} .cell-${columnKey}`);
        cells.forEach(cell => {
            cell.classList.toggle('d-none', !isVisible);
        });
    }
}
    function areSublocationFiltersFilled() {
        return sublocationCentroInput.value.trim() && sublocationAlmacenInput.value.trim();
    }
    async function manageSublocationScannerState() {
        if (areSublocationFiltersFilled()) {
            startSublocationScanButton.disabled = false;
            sublocationReaderMessage.textContent = '';
            sublocationReaderMessage.style.display = 'none';
        } else {
            startSublocationScanButton.disabled = true;
            if (isSublocationScanning) await stopSublocationScanner();
            sublocationReaderMessage.textContent = getText('completeFiltersToScan');
            sublocationReaderMessage.style.display = 'block';
        }
    }
    async function startSublocationScanner() {
        if (isSublocationScanning) return;
        isSublocationScanning = true;
        sublocationReaderMessage.style.display = 'none';
        sublocationReader.style.display = 'block';
        startSublocationScanButton.style.display = 'none';
        stopSublocationScanButton.style.display = 'inline-block';
        sublocationScanStatus.textContent = getText('readyToScan');
        sublocationScanStatus.className = "lead mt-2 message-success";
        html5QrCodeSublocation = new Html5Qrcode("sublocationReader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        try {
            await html5QrCodeSublocation.start({ facingMode: "environment" }, config, onSublocationScanSuccess, (errorMessage) => {});
        } catch (err) {
            sublocationScanStatus.textContent = `${getText('cameraError')}: ${err}`;
            sublocationScanStatus.className = "lead mt-2 message-error";
            isSublocationScanning = false;
            sublocationReader.style.display = 'none';
            startSublocationScanButton.style.display = 'block';
            stopSublocationScanButton.style.display = 'none';
        }
    }
    async function stopSublocationScanner() {
        if (!isSublocationScanning || !html5QrCodeSublocation) return;
        try {
            await html5QrCodeSublocation.stop();
        } catch(err) { /* Ignorar error al detener */ }
        isSublocationScanning = false;
        sublocationReader.style.display = 'none';
        startSublocationScanButton.style.display = 'block';
        stopSublocationScanButton.style.display = 'none';
    }
    async function onSublocationScanSuccess(decodedText) {
        if (!decodedText) return;
        await stopSublocationScanner();
        sublocationQrContent.textContent = decodedText;
        sublocationScanStatus.textContent = `${getText('processingSublocation')}: ${decodedText}...`;
        sublocationScanStatus.className = "lead mt-2";
        const selectedArea = document.querySelector('input[name="sublocationArea"]:checked').value;
        showSpinner();
        try {
            const response = await fetch(`${API_BASE_URL}/getSublocationData`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    connection_params: sapConnection,
                    centro: sublocationCentroInput.value.trim(),
                    almacen: sublocationAlmacenInput.value.trim(),
                    sublocation: decodedText,
                    area: (sublocationCentroInput.value.trim() === '4000') ? selectedArea : null,
                    is_guest: isGuestMode
                })
            });
            const result = await response.json();
            if (result.success) {
                sublocationData = result.data;
                sortState = { column: null, direction: 'asc' };
                sublocationScanStatus.textContent = getText('recordsFound').replace('{count}', sublocationData.length);
                sublocationScanStatus.className = "lead mt-2 message-success";
                filterAndRender();
                playSound('beep');
            } else {
                throw new Error(result.error);
            }
        } catch (err) {
            sublocationScanStatus.textContent = `Error: ${err.message}`;
            sublocationScanStatus.className = "lead mt-2 message-error";
            playSound('error');
            renderSublocationTable([]);
        } finally {
            hideSpinner();
        }
    }
    function filterAndRender() {
        const filterText = filterInput.value.toLowerCase();
        const filteredData = sublocationData.filter(item => {
            if (!filterText) return true;
            return Object.values(item).some(val =>
                String(val).toLowerCase().includes(filterText)
            );
        });
        renderSublocationTable(filteredData);
    }
    function renderSublocationTable(data) {
        sublocationTableBody.innerHTML = '';
        exportToExcelButton.disabled = !data || data.length === 0;
        if (!data || data.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="${Object.keys(sublocationColumnVisibility).length}" class="text-center">${getText('noDataFound', 'No data found')}</td>`;
            sublocationTableBody.appendChild(tr);
            return;
        }
        const headers = document.querySelectorAll('#sublocationTableHead th');
        data.forEach(item => {
            const tr = document.createElement('tr');
            headers.forEach(th => {
                const columnKey = th.dataset.column;
                if (columnKey) {
                    const td = document.createElement('td');
                    td.className = `cell-${columnKey}`;
                    td.textContent = item[columnKey] || '';
                    tr.appendChild(td);
                }
            });
            sublocationTableBody.appendChild(tr);
        });
        updateSortArrows();
        updateTableVisibility('sublocationTable', sublocationColumnVisibility);
    }
    function handleSort(e) {
        const header = e.target.closest('th');
        if (!header) return;
        const column = header.dataset.column;
        if (!column) return;
        if (sortState.column === column) {
            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
        } else {
            sortState.column = column;
            sortState.direction = 'asc';
        }
        sortData();
    }
    function sortData() {
        const { column, direction } = sortState;
        if (!column) return;
        const filterText = filterInput.value.toLowerCase();
        const dataToSort = sublocationData.filter(item => {
            if (!filterText) return true;
            return Object.values(item).some(val =>
                String(val).toLowerCase().includes(filterText)
            );
        });
        dataToSort.sort((a, b) => {
            let valA = a[column];
            let valB = b[column];
            const numA = parseFloat(valA);
            const numB = parseFloat(valB);
            if (!isNaN(numA) && !isNaN(numB)) {
                valA = numA;
                valB = numB;
            } else {
                valA = String(valA).toLowerCase();
                valB = String(valB).toLowerCase();
            }
            if (valA < valB) {
                return direction === 'asc' ? -1 : 1;
            }
            if (valA > valB) {
                return direction === 'asc' ? 1 : -1;
            }
            return 0;
        });
        renderSublocationTable(dataToSort);
    }
    function updateSortArrows() {
        document.querySelectorAll('#sublocationTable thead th').forEach(th => {
            const arrow = th.querySelector('.sort-arrow');
            if (!arrow) return;
            if (th.dataset.column === sortState.column) {
                arrow.innerHTML = sortState.direction === 'asc' ? '&#9650;' : '&#9660;';
                arrow.style.opacity = '1';
            } else {
                arrow.innerHTML = '';
                arrow.style.opacity = '0.5';
            }
        });
    }
    function exportToExcel() {
        if (sublocationData.length === 0) {
            alert(getText('noDataToExport'));
            return;
        }
        const filterText = filterInput.value.toLowerCase();
        const dataToExport = sublocationData.filter(item => {
            if (!filterText) return true;
            return Object.values(item).some(val =>
                String(val).toLowerCase().includes(filterText)
            );
        });
        if (dataToExport.length === 0) {
            alert(getText('noFilteredDataToExport'));
            return;
        }
        const visibleHeaders = [];
        const visibleColumnKeys = [];
        document.querySelectorAll("#sublocationTableHead th").forEach(th => {
            const columnKey = th.dataset.column;
            if (columnKey && sublocationColumnVisibility[columnKey]) {
                visibleHeaders.push(th.textContent.replace(' ▲', '').replace(' ▼', '').trim());
                visibleColumnKeys.push(columnKey);
            }
        });
        const dataWithVisibleHeaders = dataToExport.map(row => {
            const newRow = {};
            visibleHeaders.forEach((header, index) => {
                const columnKey = visibleColumnKeys[index];
                newRow[header] = row[columnKey];
            });
            return newRow;
        });
        const worksheet = XLSX.utils.json_to_sheet(dataWithVisibleHeaders);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Consulta");
        const today = new Date().toISOString().slice(0, 10);
        XLSX.writeFile(workbook, `Consulta_Sububicacion_${today}.xlsx`);
    }
    function clearAllScreens() {
        msegTableBody.innerHTML = '';
        scannedCodes.clear();
        qrContentElement.textContent = '';
        clMovimientoInput.value = '';
        specialStockIndicatorInput.value = '';
        centroInput.value = '';
        almacenInput.value = '';
        textoCabeceraInput.value = '';
        reservaCheckbox.checked = false;
        setScanStatus("", "");
        updateButtonsVisibility();
        toggleReservaColumn();
        sublocationCentroInput.value = '';
        sublocationAlmacenInput.value = '';
        sublocationQrContent.textContent = '';
        sublocationTableBody.innerHTML = '';
        sublocationScanStatus.textContent = '';
        filterInput.value = '';
        document.getElementById('areaTodos').checked = true;
        sublocationAreaContainer.style.display = 'none';
        sublocationData = [];
        sortState = { column: null, direction: 'asc' };
        updateSortArrows();
        exportToExcelButton.disabled = true;
        clearIngresoForm(true);
        msegColumnVisibility = initializeColumnVisibility('msegTable');
        sublocationColumnVisibility = initializeColumnVisibility('sublocationTable');
        updateTableVisibility('msegTable', msegColumnVisibility);
        updateTableVisibility('sublocationTable', sublocationColumnVisibility);
    }
  //  function updateIngresoTableVisibility() {
  //      const stockType = document.querySelector('input[name="ingresoStockEspecial"]:checked').value;
  //      document.querySelectorAll('#ingresoItemsTable .wbs-col').forEach(el => el.style.display = stockType === 'Q' ? '' : 'none');
  //      document.querySelectorAll('#ingresoItemsTable .so-col').forEach(el => el.style.display = stockType === 'E' ? '' : 'none');
  //  }
    async function fetchPurchaseOrderItems() {
        const poNumber = ingresoNroPedidoInput.value.trim();
        if (!poNumber) { clearIngresoForm(false); return; }
        setIngresoStatus(`${getText('searchingPO')} ${poNumber}...`, 'info');
        showSpinner();
        try {
            const response = await fetch(`${API_BASE_URL}/getPurchaseOrderItems`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ connection_params: sapConnection, po_number: poNumber, is_guest: isGuestMode })
            });
            const result = await response.json();
            if (result.success && result.items) {
                poItemsData = result.items;
                renderIngresoItemsTable(result.items);
                setIngresoStatus(result.items.length > 0 ? `${result.items.length} ${getText('itemsLoaded')}` : getText('noItemsFound'), 'success');
                ingresoSaveButton.disabled = true;
                playSound('beep');
            } else {
                throw new Error(result.error || 'Respuesta inválida.');
            }
        } catch (err) {
            clearIngresoForm(false);
            setIngresoStatus(`Error: ${err.message}`, 'error');
            playSound('error');
        } finally {
            hideSpinner();
        }
    }
    
   function renderIngresoItemsTable(items) {
    // PASO 1: Analizar todos los items para decidir qué columnas mostrar
    let showWbsColumn = false;
    let showSoColumn = false;
    items.forEach(item => {
        if (item.SOBKZ === 'Q') showWbsColumn = true;
        if (item.SOBKZ === 'E') showSoColumn = true;
    });

    // PASO 2: Mostrar u ocultar las cabeceras de las columnas
    document.querySelectorAll('#ingresoItemsTable .wbs-col').forEach(el => el.style.display = showWbsColumn ? '' : 'none');
    document.querySelectorAll('#ingresoItemsTable .so-col').forEach(el => el.style.display = showSoColumn ? '' : 'none');

    // PASO 3: Renderizar las filas
    ingresoItemsTableBody.innerHTML = '';
    selectAllIngresoItemsCheckbox.checked = false;
    
    items.forEach(item => {
        const tr = document.createElement('tr');
        tr.dataset.pos = item.EBELP;
        const posSinCeros = parseInt(item.EBELP, 10);
        const materialSinCeros = (item.MATNR || '').replace(/^0+/, '');
        const stockIndicator = item.SOBKZ || '';
        let defaultAlmacen = item.LGORT || ''; 
        let defaultSublocation = '';
        const planta = item.WERKS;
        
     if (!defaultAlmacen) { 
            if (planta === '1000') {
                defaultAlmacen = 'LI01';
            } else if (planta === '4000') {
                defaultAlmacen = '4004';
            }
        }
        
        // Lógica para SUB-UBICACIÓN: Se aplica siempre para esas plantas
        if (planta === '1000' || planta === '4000') {
            defaultSublocation = '00.00';
        }

        // --- LÓGICA DE CONSTRUCCIÓN DINÁMICA DE LA FILA ---
        // Se inicia la cadena HTML de la fila
        let rowHtml = `
            <td><input type="checkbox" class="form-check-input item-checkbox"></td>
            <td>${posSinCeros}</td>
            <td>${stockIndicator}</td>
            <td>${materialSinCeros}</td>
            <td class="material-description-cell" style="cursor: pointer;">${item.TXZ01}</td>
        `;

        // Se AÑADE la celda PEP solo si la columna es visible
        if (showWbsColumn) {
            const wbsContent = (stockIndicator === 'Q') ? (item.PS_PSP_PNR_D || '') : '';
            rowHtml += `<td class="wbs-col">${wbsContent}</td>`;
        }

        // Se AÑADEN las celdas de Pedido Venta solo si la columna es visible
        if (showSoColumn) {
            const soNumContent = (stockIndicator === 'E') ? (item.KDAUF || '') : '';
            const soItemContent = (stockIndicator === 'E') ? (item.KDPOS || '') : '';
            rowHtml += `<td class="so-col">${soNumContent}</td>`;
            rowHtml += `<td class="so-col">${soItemContent}</td>`;
        }
        
        // Se AÑADE el resto de las celdas
        rowHtml += `
            <td>${item.WERKS}</td>
            <td>
                <div class="input-group input-group-sm">
                    <input type="text" class="form-control form-control-sm" name="almacen" value="${defaultAlmacen}">
                    <button class="btn btn-outline-secondary search-btn" type="button" data-search-type="almacen"><i class="bi bi-search"></i></button>
                </div>
            </td>
            <td><input type="number" class="form-control form-control-sm" name="cantidad" value="${item.MENGE || 0}"></td>
            <td>${item.MEINS}</td>
            <td>
                <div class="input-group input-group-sm">
                    <input type="text" class="form-control" name="lote">
                    <button class="btn btn-outline-secondary search-btn" type="button" data-search-type="lote"><i class="bi bi-search"></i></button>
                </div>
            </td>
            <td>
                <div class="input-group input-group-sm">
                    <input type="text" class="form-control" name="sublocation" value="${defaultSublocation}">
                    <button class="btn btn-outline-secondary search-btn" type="button" data-search-type="sublocation"><i class="bi bi-search"></i></button>
                </div>
            </td>
            <td>
                <div class="input-group input-group-sm">
                    <input type="text" class="form-control" name="tag">
                    <button class="btn btn-outline-secondary search-btn" type="button" data-search-type="tag"><i class="bi bi-search"></i></button>
                </div>
            </td>
            <td>
                <div class="input-group input-group-sm">
                    <input type="text" class="form-control" name="pais">
                    <button class="btn btn-outline-secondary search-btn" type="button" data-search-type="pais"><i class="bi bi-search"></i></button>
                </div>
            </td>
            <td><input type="text" class="form-control form-control-sm" name="sgtxt"></td>
            <td><input type="file" class="form-control form-control-sm" name="certificado"></td>
            <td><input type="file" class="form-control form-control-sm" name="documentos"></td>
            <td><input type="file" class="form-control form-control-sm" name="inspeccion"></td>
        `;

        // Se asigna el HTML construido a la fila
        tr.innerHTML = rowHtml;
        ingresoItemsTableBody.appendChild(tr);
    });
}
    async function saveIngresoData(signatureData) {
        const selectedItems = [];
        ingresoItemsTableBody.querySelectorAll('.item-checkbox:checked').forEach(checkbox => {
            const tr = checkbox.closest('tr');
            const pos = tr.dataset.pos;
            const originalItem = poItemsData.find(d => d.EBELP === pos);
            if (originalItem) {
                selectedItems.push({
                    posicion: pos,
                    stock_especial: originalItem.SOBKZ || '',
                    material: originalItem.MATNR,
                    plant: originalItem.WERKS,
                    um: originalItem.MEINS,
                    almacen: tr.querySelector('[name="almacen"]').value,
                    cantidad: tr.querySelector('[name="cantidad"]').value,
                    lote: tr.querySelector('[name="lote"]').value,
                    sublocation: tr.querySelector('[name="sublocation"]').value,
                    tag: tr.querySelector('[name="tag"]').value,
                    pais: tr.querySelector('[name="pais"]').value,
                    sgtxt: tr.querySelector('[name="sgtxt"]').value
                });
            }
        });
        if (selectedItems.length === 0) { alert('Debe seleccionar al menos una posición.'); return; }
        
        setIngresoStatus(getText('preparingData'), 'info');
        showSpinner();
        const headerData = {
            nro_pedido: document.getElementById('ingresoNroPedido').value,
            tipo_movimiento: document.getElementById('ingresoTipoMovimiento').value,
           // stock_especial: document.querySelector('input[name="ingresoStockEspecial"]:checked').value,
            fecha_doc: document.getElementById('ingresoFechaDoc').value,
            fecha_cont: document.getElementById('ingresoFechaCont').value,
            material_slip: document.getElementById('ingresoMaterialSlip').value,
            texto_cabecera: document.getElementById('ingresoTextoCabecera').value,
        };
        const formData = new FormData();
        formData.append('json_data', JSON.stringify({
            connection_params: sapConnection, is_guest: isGuestMode, header: headerData, items: selectedItems,
            signature_data: signatureData
        }));
        const fileMetadata = [];
        ingresoItemsTableBody.querySelectorAll('.item-checkbox:checked').forEach(checkbox => {
            const tr = checkbox.closest('tr');
            const pos = tr.dataset.pos;
            const certFile = tr.querySelector('[name="certificado"]').files[0];
            const docFile = tr.querySelector('[name="documentos"]').files[0];
            const inspFile = tr.querySelector('[name="inspeccion"]').files[0];
            if (certFile) { formData.append('files[]', certFile); fileMetadata.push({ posicion: pos, field: 'certificado', filename: certFile.name }); }
            if (docFile) { formData.append('files[]', docFile); fileMetadata.push({ posicion: pos, field: 'documentos', filename: docFile.name }); }
            if (inspFile) { formData.append('files[]', inspFile); fileMetadata.push({ posicion: pos, field: 'inspeccion', filename: inspFile.name }); }
        });
        formData.append('file_metadata', JSON.stringify(fileMetadata));
        
        try {
            const response = await fetch(`${API_BASE_URL}/saveIngreso`, { method: 'POST', body: formData });
            const result = await response.json();
            if (result.success) {
                let msg = getText('successDocCreated').replace('{doc_number}', result.doc_number);
                if(result.warning) msg += `\n\nADVERTENCIA:\n${result.warning}`;
                
                setIngresoStatus(msg, result.warning ? 'warning' : 'success');
                playSound('beep');
                alert(msg);

                lastSavedIngresoData = {
                    doc_number: result.doc_number,
                    doc_year: headerData.fecha_cont.substring(0, 4),
                    items: selectedItems
                };

                ingresoSaveButton.style.display = 'none';
                printLabelsButton.style.display = 'inline-block';
                printDocMaterialButton.style.display = 'inline-block';
                
                document.querySelectorAll('#ingresoContent input, #ingresoContent button').forEach(el => {
                    if(el.id !== 'ingresoClearButton' && el.id !== 'printLabelsButton' && el.id !== 'printDocMaterialButton' && el.id !== 'backButtonIngreso' && el.id !== 'logoutButtonIngreso') {
                        el.disabled = true;
                    }
                });

            } else {
                throw new Error(result.error);
            }
        } catch (err) {
            setIngresoStatus(`${getText('savingError')}: ${err.message}`, 'error');
            playSound('error');
            alert(`${getText('savingError')}: ${err.message}`);
        } finally {
            hideSpinner();
        }
    }

    async function handlePrintLabels() {
        if (!lastSavedIngresoData) {
            alert("No hay datos del último guardado para imprimir.");
            return;
        }
        setIngresoStatus(getText('generatingLabels', 'Generando etiquetas...'), 'info');
        showSpinner();
        try {
            const response = await fetch(`${API_BASE_URL}/printIngresoLabels`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    connection_params: sapConnection,
                    print_data: lastSavedIngresoData
                })
            });
            const result = await response.json();
            if (result.success && result.pdf_data) {
                const pdfBlob = new Blob([Uint8Array.from(atob(result.pdf_data), c => c.charCodeAt(0))], { type: 'application/pdf' });
                const pdfUrl = URL.createObjectURL(pdfBlob);
               const anchor = document.createElement('a');
    anchor.style.display = 'none';
    anchor.href = pdfUrl;
    anchor.target = "_blank";

    // 2. Asignarle un nombre de archivo para la descarga
    anchor.download = 'Etiquetas.pdf';

    // 3. Añadirlo a la página, simular un clic y removerlo
    document.body.appendChild(anchor);
    anchor.click();
    window.URL.revokeObjectURL(pdfUrl); // Limpiar la URL del objeto
    document.body.removeChild(anchor);
    // --- FIN DEL CAMBIO ---

    setIngresoStatus(getText('labelsGenerated'), 'success');
            } else {
                throw new Error(result.error || "No se recibieron datos del PDF desde el servidor.");
            }
        } catch (err) {
            setIngresoStatus(`${getText('printingError', 'Error al imprimir')}: ${err.message}`, 'error');
            playSound('error');
            alert(`${getText('printingError', 'Error al generar etiquetas')}: ${err.message}`);
        } finally {
            hideSpinner();
        }
    }

     async function handlePrintDocMaterial() {
        if (!lastSavedIngresoData) {
            alert("No hay datos del último guardado para imprimir.");
            return;
        }
        setIngresoStatus(getText('generatingMaterialDoc', 'Generando Documento de Material...'), 'info');
        showSpinner();
        try {
            // Esta función llama a la nueva ruta /printMaterialDoc
            const response = await fetch(`${API_BASE_URL}/printMaterialDoc`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    connection_params: sapConnection,
                    print_data: lastSavedIngresoData
                })
            });
            const result = await response.json();
            if (result.success && result.pdf_data) {
                const pdfBlob = new Blob([Uint8Array.from(atob(result.pdf_data), c => c.charCodeAt(0))], { type: 'application/pdf' });
                const pdfUrl = URL.createObjectURL(pdfBlob);
               const anchor = document.createElement('a');
    anchor.style.display = 'none';
    anchor.href = pdfUrl;
    anchor.target = "_blank";
    anchor.download = 'Documento_Material.pdf'; // Nombre de archivo para este caso

    document.body.appendChild(anchor);
    anchor.click();
    window.URL.revokeObjectURL(pdfUrl);
    document.body.removeChild(anchor);
    // --- FIN DEL CAMBIO ---

    setIngresoStatus(getText('materialDocGenerated', 'Documento generado.'), 'success');
            } else {
                throw new Error(result.error || "No se recibieron datos del PDF desde el servidor.");
            }
        } catch (err) {
            setIngresoStatus(`${getText('printingError', 'Error al imprimir')}: ${err.message}`, 'error');
            playSound('error');
            alert(`${getText('printingError', 'Error al generar documento')}: ${err.message}`);
        } finally {
            hideSpinner();
        }
    }

    function clearIngresoForm(clearAll = true) {
    // Limpia la tabla y los datos en memoria
    ingresoItemsTableBody.innerHTML = '';
    poItemsData = []; // <-- IMPORTANTE: Resetea los datos de las posiciones
    selectAllIngresoItemsCheckbox.checked = false;

    // Si clearAll es true (llamado por Limpiar o Volver), limpia también la cabecera
    if (clearAll) {
        ingresoNroPedidoInput.value = '';
        // Resetea todos los campos de cabecera a sus valores por defecto
        document.getElementById('ingresoTipoMovimiento').value = '101';
        document.getElementById('ingresoFechaDoc').valueAsDate = new Date();
        document.getElementById('ingresoFechaCont').valueAsDate = new Date();
        document.getElementById('ingresoMaterialSlip').value = '';
        document.getElementById('ingresoTextoCabecera').value = '';
        document.querySelectorAll('#ingresoItemsTable .wbs-col').forEach(el => el.style.display = 'none');
    document.querySelectorAll('#ingresoItemsTable .so-col').forEach(el => el.style.display = 'none');
    }

    // Lógica para resetear el estado de los botones y mensajes
    setIngresoStatus('', 'info');
    lastSavedIngresoData = null;
    
    // Habilita todos los campos y botones, excepto los de impresión
    document.querySelectorAll('#ingresoContent input, #ingresoContent button').forEach(el => {
        if (el.id !== 'printLabelsButton' && el.id !== 'printDocMaterialButton') {
            el.disabled = false;
        }
    });

    // Muestra/oculta los botones según el estado
    ingresoSaveButton.style.display = 'inline-block';
    printLabelsButton.style.display = 'none';
    printDocMaterialButton.style.display = 'none';
    ingresoSaveButton.disabled = true; // El botón de guardar se deshabilita hasta que se seleccione algo
}

    function setIngresoStatus(message, type) {
        ingresoStatus.textContent = message;
        ingresoStatus.className = `mt-3 text-center message-${type}`;
    }
    
    async function fetchAndShowLongText(materialNumber) {
        const modalBody = document.getElementById('longTextModalBody');
        modalBody.textContent = getText('loading', 'Cargando...');
        longTextModal.show();
        showSpinner();
        try {
            const response = await fetch(`${API_BASE_URL}/getLongText`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    connection_params: sapConnection,
                    material_number: materialNumber,
                    lang: currentLang
                })
            });
            const result = await response.json();
            if (result.success) {
                modalBody.textContent = result.long_text || 'No se encontró texto extendido.';
            } else {
                throw new Error(result.error);
            }
        } catch (err) {
            modalBody.textContent = `Error al cargar el texto: ${err.message}`;
            playSound('error');
        } finally {
            hideSpinner();
        }
    }

    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

    msegColumnVisibility = initializeColumnVisibility('msegTable');
    sublocationColumnVisibility = initializeColumnVisibility('sublocationTable');
});
</script>
</body>
</html>
